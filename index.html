<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">ðŸ“¦ Dashboard Tracking</h1>

  <!-- Search & Filter -->
  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-6">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari...">
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Tabel data -->
  <div class="card table-responsive mb-4">
    <div class="card-header">Data Tracking</div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover mb-0" id="dataTable">
        <thead class="table-dark"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzB7aCsWp8hznss2sLW7EUtx4zAuBGqa-HcuBs2vihEqdTAP6Fc4JGuDWblp-VThmGoyA/exec"; // ganti
let fullData = [];
let columns = [];
let visibleColumns = ["TGL ORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT","NO. RESI","PELACAKAN TERBARU","TANGGAL UPDATE","STATUS","DURASI KIRIM"];

// Load data
function loadData() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      columns = data[0];          // header sheet
      fullData = data.slice(1);   // data
      if (visibleColumns.length === 0) visibleColumns = [...columns]; // default semua visible
      renderFilterOptions();
      renderTable();
    });
}

// Render filter select (misal status)
function renderFilterOptions() {
  const filter = document.getElementById("filterStatus");
  filter.innerHTML = '<option value="">Filter Status</option>';

  const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
  if (statusIdx >= 0) {
    const statuses = [...new Set(fullData.map(r => r[statusIdx]))].filter(s => s);
    statuses.forEach(s => filter.innerHTML += `<option value="${s}">${s}</option>`);
  }
}

// Render tabel
function renderTable() {
  const thead = document.querySelector("#dataTable thead tr");
  const tbody = document.querySelector("#dataTable tbody");

  thead.innerHTML = "<th>#</th>";
  visibleColumns.forEach(col => thead.innerHTML += `<th>${col}</th>`);
  thead.innerHTML += "<th>AKSI</th>";

  const keyword = document.getElementById("searchBox")?.value.toLowerCase() || "";
  const filterStatus = document.getElementById("filterStatus")?.value || "";

  tbody.innerHTML = "";
  fullData.forEach((row, i) => {
    const matchKeyword = keyword === "" || row.some(cell => String(cell).toLowerCase().includes(keyword));
    const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
    const matchStatus = !filterStatus || (statusIdx >= 0 && String(row[statusIdx]) === filterStatus);

    if (!matchKeyword || !matchStatus) return;

    let tr = document.createElement("tr");
    let cells = `<td>${i+1}</td>`;
    visibleColumns.forEach(col => {
      const idx = columns.indexOf(col);
      cells += `<td>${row[idx] || ""}</td>`;
    });
    cells += `<td>
                <button class="btn btn-sm btn-warning" onclick="showEditFull(${i})">Edit</button>
              </td>`;
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

// Fungsi edit
function showEditFull(idx){
  const modalBody = document.querySelector("#editForm .modal-body");
  modalBody.innerHTML = "";
  const dataRow = fullData[idx];

  columns.forEach((col,i)=>{
    const val = dataRow[i] || "";
    const div = document.createElement("div");
    div.className = "mb-3";
    div.innerHTML = `<label>${col}</label>
                     <input type="text" class="form-control" name="${col}" value="${val}">`;
    modalBody.appendChild(div);
  });

  const rowInput = document.createElement("input");
  rowInput.type = "hidden";
  rowInput.name = "row";
  rowInput.value = idx+2; // baris di sheet
  modalBody.appendChild(rowInput);

  new bootstrap.Modal(document.getElementById("editModal")).show();
}

// Submit modal (update aman)
document.getElementById("editForm").addEventListener("submit", function(e){
  e.preventDefault();
  let formData = new FormData(this);
  formData.append("action","update");

  fetch(API_URL, {method:"POST", body:formData})
    .then(res=>res.text())
    .then(msg=>{
      alert(msg);
      loadData();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    });
});

// Filter & search
document.getElementById("searchBox").addEventListener("input", renderTable);
document.getElementById("filterStatus").addEventListener("change", renderTable);
function resetFilter() {
  document.getElementById("searchBox").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
}

// Load pertama kali
loadData();
</script>

</body>
</html>
