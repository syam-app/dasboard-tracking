<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .table-responsive { overflow-x: auto; }
    .mengecil{font-size: 0.9rem;}
    #searchBox,
    #filterStatus,
    #searchBox::placeholder,
    .search-filter .btn {
      font-size: 0.9rem !important;
    }
    #pagination {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 12px;
      gap: 4px;
    }
    #pagination .btn {
      padding: 2px 8px;
      font-size: 0.8rem;
      border-radius: 6px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4 fw-bold">ðŸ“¦ Dashboard Tracking</h1>

  <!-- Search & Filter -->
  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-6">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari...">
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Tabel data -->
  <div class="card table-responsive">
    <div class="card-header lead">Data Tracking</div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover mb-0 mengecil" id="dataTable">
        <thead class="table-dark"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<div id="pagination" class="mb-4"></div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== CONFIG =====================
const API_URL = "https://script.google.com/macros/s/AKfycbypYKYYfsuTE5F4bWoO4WmPlegB6nE1UZsArLsKKd1TBBWA5TWw5gf6Em0-R89XZzi8/exec"; 

// Kolom yang ingin ditampilkan di tabel (urutannya bisa diatur di sini)
let visibleColumns = [
  "TGL ORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT",
  "NO. RESI","KURIR","PELACAKAN TERBARU","TANGGAL UPDATE","STATUS",
  "DURASI KIRIM","SINCE LASTUPDATE"
];

// Template pesan WA
const waTemplates = {
  infopesanan: `*DATA PESANAN*
_{TGLORDER}_
-------------------
_*Info Pemesan*_
{NAMA} | 62{WHATSAPP}
{DETAIL ALAMAT}
{ALAMAT}

_*Info Pesanan*_
{OBATNYA}
Pembayaran {PAYMENT}
  
_*Info Pengiriman*_
No. Resi  : {NORESI}
Ekspedisi : {KURIRE}`,
  infotracking: "Halo Pak/Bu {NAMA}, Pesanan Anda {OBATNYA} dengan nomor resi *{NORESI}* status saat ini *{STATUS}*. *{TRACKING}* di update pada *{TGLUPDATE}*. Terima kasih :)",
  followup: "Halo Pak/Bu {NAMA}, Bagaimana perkembangannya setelah konsumsi {OBATNYA}?",
  reminder: "Halo Pak/Bu {NAMA}, jangan lupa untuk konfirmasi penerimaan paket Anda ya ðŸ˜Š",
  invoice: `*DATA PESANAN*
---------------------------------------------
_{TGLORDER}_

_*Info Pemesan*_
{NAMA} | 62{WHATSAPP}
{DETAIL ALAMAT}
{ALAMAT}

_*Info Pesanan*_
{OBATNYA}
Pembayaran {PAYMENT}
  
_*Info Pengiriman*_
No. Resi  : {NORESI}
Ekspedisi : {KURIRE}
~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~

*INVOICE*
---------------------------------------------
_Kepada Pak/Bu {NAMA}_

_*Ringkasan Pesanan*_
- {ITEMS}

_*Ringkasan Tagihan*_
- Subtotal Obat    : Rp {SUBTOTAL}
- Ongkir               : Rp {ONGKIR}
- Diskon Obat      : ~Rp {DISKON_OBAT}~
- Diskon Ongkir   : ~Rp {DISKON_ONGKIR}~

> Anda hemat Rp {HEMAT}
--------------------------------------
*Total Tagihan COD : Rp {TOTAL}*`
};

// ===================== STATE (Server-side) =====================
let headers = [];
let pageData = [];            // data pada halaman aktif (array of rows)
let totalRows = 0;            // total hasil setelah filter/search dari server
let currentPage = 1;          // halaman aktif
let rowsPerPage = 10;         // limit per halaman (sinkron dengan param "limit")
let currentSearch = "";       // keyword pencarian
let currentStatus = "";       // filter status

// ===================== FUNGSI UTIL =====================
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; 
  return d.toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit"
  });
}
function formatPhone(number) {
  if (!number) return "";
  let cleaned = number.toString().replace(/\D/g,""); 
  if (cleaned.startsWith("62")) return cleaned;
  if (cleaned.startsWith("0")) return "62" + cleaned.slice(1);
  return "62" + cleaned; 
}
function fillTemplate(template, row) {
  let text = template;
  headers.forEach((col, i) => {
    const key = col.replace(/\./g,"");
    const val = row[i] || "";
    text = text.replace(new RegExp("\\{"+key+"\\}", "gi"), val);
  });
  return text;
}
function parseRupiah(str) {
  if (!str) return 0;
  return parseInt(String(str)
    .replace(/Rp/g, "")
    .replace(/\s/g, "")
    .replace(/\./g, "")
    .replace(/,/g, "")
    .replace(/~/g, "")
  ) || 0;
}
function formatRupiah(num) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0
  }).format(Number(num) || 0);
}
function formatKurir(code) {
  if (!code) return "";
  const map = { spx:"SPX Express", jnt:"J&T Express", jne:"JNE Express", ninja:"NINJA Express", ide:"ID Express" };
  const key = String(code).toLowerCase().trim();
  return map[key] || code;
}

// Hitung kolom "SINCE LASTUPDATE" pada pageData
function hitungSejakDiterima(rows) {
  const idxUpdate = headers.indexOf("TANGGAL UPDATE");
  let idxSejak = headers.indexOf("SINCE LASTUPDATE");
  if (idxSejak === -1) {
    headers.push("SINCE LASTUPDATE");
    idxSejak = headers.length - 1;
  }
  const now = new Date();
  rows.forEach(r => {
    const tgl = new Date(r[idxUpdate]);
    if (!isNaN(tgl)) {
      const diffMs = now - tgl;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const days = Math.floor(diffHours / 24);
      const hours = diffHours % 24;
      let result = "";
      if (days > 0) result += days + " Hari";
      if (hours > 0) result += (result ? " " : "") + hours + " Jam";
      r[idxSejak] = (result || "0 Jam") + " yang lalu";
    } else {
      r[idxSejak] = "";
    }
  });
}

// ===================== DATA LOADING (SERVER-SIDE) =====================
async function loadData() {
  const params = new URLSearchParams({
    page: String(currentPage),
    limit: String(rowsPerPage),
    search: currentSearch,
    status: currentStatus
  });
  const res = await fetch(`${API_URL}?${params.toString()}`);
  const json = await res.json();

  headers = json.headers || [];
  pageData = (json.data || []).map((row) => [...row]);
  totalRows = json.total || 0;
  currentPage = json.page || 1;
  rowsPerPage = json.limit || rowsPerPage;

  // Tambahkan kolom "SINCE LASTUPDATE" (client-side derived)
  hitungSejakDiterima(pageData);

  renderFilterOptions();
  renderTable();
}

// ===================== FILTER (CLIENT UI â†’ SERVER REQUEST) =====================
function renderFilterOptions() {
  // Catatan: sekarang status difilter di server. 
  // Jika ingin opsi dinamis global, perlu endpoint khusus. 
  // Di sini kita biarkan opsi <select> ditentukan di HTML, atau (fallback) isi dari pageData saat ini.
  const filter = document.getElementById("filterStatus");
  if (!filter) return;
  if (filter.options.length > 1) return; // asumsikan HTML sudah men-setup opsi; jangan overwrite

  const statusIdx = headers.indexOf("STATUS");
  if (statusIdx >= 0) {
    const statuses = [...new Set(pageData.map(r => r[statusIdx]))].filter(s => s);
    statuses.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      filter.appendChild(opt);
    });
  }
}

// Event search & filter (mengirim request baru ke server)
document.getElementById("searchBox")?.addEventListener("input", () => {
  currentSearch = document.getElementById("searchBox").value.trim();
  currentPage = 1;
  loadData();
});
document.getElementById("filterStatus")?.addEventListener("change", () => {
  currentStatus = document.getElementById("filterStatus").value;
  currentPage = 1;
  loadData();
});
function resetFilter() {
  const s = document.getElementById("searchBox");
  const f = document.getElementById("filterStatus");
  if (s) s.value = "";
  if (f) f.value = "";
  currentSearch = ""; currentStatus = ""; currentPage = 1;
  loadData();
}

// ===================== PAGINATION (PAKAI TOTAL DARI SERVER) =====================
function changePage(page) {
  currentPage = page;
  loadData();
}

// ===================== RENDER TABEL =====================
function renderTable() {
  const thead = document.querySelector("#dataTable thead tr");
  const tbody = document.querySelector("#dataTable tbody");
  if (!thead || !tbody) return;

  // Header: gunakan visibleColumns yang ada di sheet
  const availableCols = visibleColumns.filter(col => headers.includes(col));
  thead.innerHTML = "<th>#</th>" + availableCols.map(c => `<th>${c}</th>`).join("") + "<th>AKSI</th>";

  // Rows
  tbody.innerHTML = "";
  const startIndex = (currentPage - 1) * rowsPerPage; // untuk nomor urut dan rowIndex aktual

  pageData.forEach((row, i) => {
    const tr = document.createElement("tr");
    let cells = `<td>${startIndex + i + 1}</td>`;

    availableCols.forEach(col => {
      const idx = headers.indexOf(col);
      let val = row[idx] ?? "";
      if (col === "TGL ORDER" || col === "TANGGAL UPDATE") val = formatDate(val);
      cells += `<td>${val}</td>`;
    });

    // Hitung row index asli di sheet: baris 1 = header â†’ +2
    const sheetRowIndex = startIndex + i + 2;

    // Aksi
    cells += `<td>
      <button class="btn btn-sm btn-warning" onclick="showEditFull(${sheetRowIndex}, ${i})"><i class="bi bi-pencil-fill"></i></button>
      <button class="btn btn-sm btn-success mt-1" onclick="showWaModal(${i})"><i class="bi bi-whatsapp"></i></button>
      <button class="btn btn-sm btn-primary mt-1" onclick="confirmTrackResi(${i})"><i class="bi bi-truck"></i></button>
    </td>`;

    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });

  // Pagination control (berdasarkan totalRows dari server)
  const paginationEl = document.getElementById("pagination");
  if (paginationEl) {
    const totalPages = Math.ceil((totalRows || 0) / rowsPerPage) || 1;
    paginationEl.innerHTML = "";

    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary me-1" onclick="changePage(1)" ${currentPage === 1 ? "disabled" : ""}>First</button>`;
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary me-1" onclick="changePage(${Math.max(1,currentPage-1)})" ${currentPage === 1 ? "disabled" : ""}>Prev</button>`;

    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;
    if (endPage > totalPages) { endPage = totalPages; startPage = Math.max(1, endPage - maxVisible + 1); }

    if (startPage > 1) {
      paginationEl.innerHTML += `<button class="btn btn-sm ${currentPage === 1 ? 'btn-primary' : 'btn-outline-primary'}" onclick="changePage(1)">1</button>`;
      if (startPage > 2) paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
    }
    for (let p = startPage; p <= endPage; p++) {
      paginationEl.innerHTML += `<button class="btn btn-sm ${p === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="changePage(${p})">${p}</button>`;
    }
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
      paginationEl.innerHTML += `<button class="btn btn-sm ${currentPage === totalPages ? 'btn-primary' : 'btn-outline-primary'}" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary ms-1" onclick="changePage(${Math.min(totalPages,currentPage+1)})" ${currentPage === totalPages ? "disabled" : ""}>Next</button>`;
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary ms-1" onclick="changePage(${Math.ceil(totalRows/rowsPerPage) || 1})" ${currentPage === totalPages ? "disabled" : ""}>Last</button>`;
  }
}

// ===================== MODAL EDIT (UPDATE ROW SAJA) =====================
function showEditFull(sheetRowIndex, localIndex){
  const modalBody = document.querySelector("#editForm .modal-body");
  if (!modalBody) return;

  modalBody.innerHTML = "";
  const dataRow = pageData[localIndex] || [];

  headers.forEach((col,i)=>{
    const val = dataRow[i] || "";
    const div = document.createElement("div");
    div.className = "mb-3";
    div.innerHTML = `<label>${col}</label>\n                     <input type="text" class="form-control" name="col_${i}" value="${String(val).replace(/"/g,'&quot;')}">`;
    modalBody.appendChild(div);
  });

  // Simpan row index asli sheet
  const rowInput = document.createElement("input");
  rowInput.type = "hidden";
  rowInput.name = "row";
  rowInput.value = sheetRowIndex; // baris real di sheet (>=2)
  modalBody.appendChild(rowInput);

  new bootstrap.Modal(document.getElementById("editModal")).show();
}

document.getElementById("editForm")?.addEventListener("submit", async function(e){
  e.preventDefault();
  const form = e.currentTarget;
  const fd = new FormData(form);
  const rowIndex = parseInt(fd.get("row"), 10);

  // Ambil array nilai sesuai urutan headers
  const rowData = headers.map((_, i) => fd.get(`col_${i}`) ?? "");

  // Kirim JSON ke GAS (updateRow satu baris saja)
  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "updateRow", rowIndex, rowData })
  });

  // Update tampilan lokal tanpa reload total: timpa pageData sesuai form
  const localIndex = (rowIndex - 2) - (rowsPerPage * (currentPage - 1));
  if (localIndex >= 0 && localIndex < pageData.length) {
    pageData[localIndex] = [...rowData];
    // Re-calc kolom derived
    hitungSejakDiterima([pageData[localIndex]]);
    renderTable();
  } else {
    // jika tidak di halaman aktif, ambil ulang
    loadData();
  }

  bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
});

// ===================== HELPER INVOICE =====================
function parseObat(obatValue, hargaSatuan) {
  if (!obatValue) return { qty: 1, namaProduk: "", itemsText: "", subtotal: 0 };
  const parts = String(obatValue).trim().split(/\s+/);
  const qty = parseInt(parts[0], 10) || 1;      // contoh: "3 Botol ..."
  const namaProduk = parts.slice(2).join(" ");  // ambil setelah kata "Botol"
  const itemsText = `${namaProduk}   x ${qty}`;
  const subtotal = qty * (Number(hargaSatuan) || 0);
  return { qty, namaProduk, itemsText, subtotal };
}
function refreshInvoiceFields(textarea, fields, obatnya, hargaSatuan) {
  const { subtotal } = parseObat(obatnya, hargaSatuan);
  const ongkir = parseInt(fields.ongkir.value, 10) || 0;
  const diskonObat = parseInt(fields.diskonObat.value, 10) || 0;
  const diskonOngkir = parseInt(fields.diskonOngkir.value, 10) || 0;
  const hemat = diskonObat + diskonOngkir;
  const total = subtotal + ongkir - hemat;

  let text = textarea.value;
  text = text.replace(/- Subtotal Obat\s*:\s*Rp[^\n]*/i, `- Subtotal Obat   : ${formatRupiah(subtotal)}`);
  text = text.replace(/- Ongkir\s*:\s*Rp[^\n]*/i, `- Ongkir               : ${formatRupiah(ongkir)}`);
  text = text.replace(/- Diskon Obat\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Obat     : ~${formatRupiah(diskonObat)}~`);
  text = text.replace(/- Diskon Ongkir\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Ongkir  : ~${formatRupiah(diskonOngkir)}~`);
  text = text.replace(/^> *Anda hemat.*$/mi, `> Anda hemat ${formatRupiah(hemat)}`);
  text = text.replace(/^\**\s*Total Tagihan COD\s*:?\s*Rp[^\n]*\**$/mi, `*Total Tagihan COD ${formatRupiah(total)}*`);
  textarea.value = text;
}

// ===================== Modal WhatsApp =====================
function showWaModal(localIndex) {
  const row = pageData[localIndex];
  if (!row) return;
  const idx = (name) => headers.indexOf(name);

  const nama = row[idx("NAMA")] || "";
  const noWa = formatPhone(row[idx("WHATSAPP")] || "");
  const tglupdate = formatDate(row[idx("TANGGAL UPDATE")] || "");
  const tglorder = formatDate(row[idx("TGL ORDER")] || "");
  const resi = row[idx("NO. RESI")] || "";
  const obatnya = row[idx("BARANG")] || "";
  const kurir = row[idx("KURIR")] || "";
  const tracking = row[idx("PELACAKAN TERBARU")] || "";
  const status = row[idx("STATUS")] || "";

  const modalId = "waModal";
  let modalEl = document.getElementById(modalId);

  if (!modalEl) {
    modalEl = document.createElement("div");
    modalEl.className = "modal fade";
    modalEl.id = modalId;
    modalEl.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Kirim WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Pesan</label>
            <textarea id="waMessage" class="form-control" rows="7"></textarea>
            
            <div class="mt-3">
              <label class="form-label">Pilih Template</label>
              <select id="waTemplate" class="form-select">
                <option value="">-- Pilih --</option>
                <option value="invoice">Invoice</option>
                <option value="infopesanan">Info Pesanan</option>
                <option value="infotracking">Info Tracking</option>
                <option value="followup">Follow Up</option>
                <option value="reminder">Pengingat</option>
              </select>
            </div>

            <div id="invoiceFields" class="mt-3" style="display:none;">
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Ongkir</label>
                  <input type="number" id="invOngkir" class="form-control" value="0" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Diskon Obat</label>
                  <input type="number" id="invDiskonObat" class="form-control" value="0" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Diskon Ongkir</label>
                  <input type="number" id="invDiskonOngkir" class="form-control" value="0" min="0">
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <a id="waSendBtn" target="_blank" class="btn btn-success">Kirim WA</a>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modalEl);
  }

  const textarea = modalEl.querySelector("#waMessage");
  const select = modalEl.querySelector("#waTemplate");
  const sendBtn = modalEl.querySelector("#waSendBtn");
  const invoiceFields = {
    container: modalEl.querySelector("#invoiceFields"),
    ongkir: modalEl.querySelector("#invOngkir"),
    diskonObat: modalEl.querySelector("#invDiskonObat"),
    diskonOngkir: modalEl.querySelector("#invDiskonOngkir"),
  };
  const hargaSatuan = 269000; // atur sesuai produk

  // Default isi template info
  textarea.value = fillTemplate(waTemplates.infopesanan, row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TGLORDER}", tglorder)
    .replace("{KURIRE}", formatKurir(kurir))
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);

  // saat pilih template
  select.onchange = () => {
    if (select.value === "invoice") {
      invoiceFields.container.style.display = "block";
      const { itemsText, subtotal } = parseObat(obatnya, hargaSatuan);
      const ongkir = parseInt(invoiceFields.ongkir.value, 10) || 0;
      const diskonObat = parseInt(invoiceFields.diskonObat.value, 10) || 0;
      const diskonOngkir = parseInt(invoiceFields.diskonOngkir.value, 10) || 0;
      const hemat = diskonObat + diskonOngkir;
      const total = subtotal + ongkir - hemat;

      textarea.value = fillTemplate(waTemplates.invoice, row)
        .replace("{TGLORDER}", tglorder)
        .replace("{NAMA}", nama)
        .replace("{ITEMS}", itemsText)
        .replace("{NORESI}", resi)
        .replace("{OBATNYA}", obatnya)
        .replace("{SUBTOTAL}", formatRupiah(subtotal))
        .replace("{ONGKIR}", formatRupiah(ongkir))
        .replace("{DISKON_OBAT}", formatRupiah(diskonObat))
        .replace("{KURIRE}", formatKurir(kurir))
        .replace("{DISKON_ONGKIR}", formatRupiah(diskonOngkir))
        .replace("{HEMAT}", formatRupiah(hemat))
        .replace("{TOTAL}", formatRupiah(total));

      [invoiceFields.ongkir, invoiceFields.diskonObat, invoiceFields.diskonOngkir].forEach(el => {
        el.oninput = () => refreshInvoiceFields(textarea, invoiceFields, obatnya, hargaSatuan);
      });

    } else if (waTemplates[select.value]) {
      invoiceFields.container.style.display = "none";
      textarea.value = fillTemplate(waTemplates[select.value], row)
        .replace("{NAMA}", nama)
        .replace("{NORESI}", resi)
        .replace("{OBATNYA}", obatnya)
        .replace("{TGLUPDATE}", tglupdate)
        .replace("{TGLORDER}", tglorder)
        .replace("{KURIRE}", formatKurir(kurir))
        .replace("{TRACKING}", tracking)
        .replace("{STATUS}", status);
    }
  };

  sendBtn.onclick = () => {
    const pesan = encodeURIComponent(textarea.value);
    window.open(`https://wa.me/${noWa}?text=${pesan}`, "_blank");
  };

  new bootstrap.Modal(modalEl).show();
}

// ===================== TRACK RESI (UPDATE KOLOM VIA updateResi) =====================
function confirmTrackResi(localIndex) {
  if (confirm("Yakin mau cek resi untuk data baris ini?")) trackResi(localIndex);
}
async function trackResi(localIndex) {
  const row = pageData[localIndex];
  if (!row) return alert("Baris tidak ditemukan.");
  const idx = (name) => headers.indexOf(name);

  const resi = row[idx("NO. RESI")];
  const kurir = row[idx("KURIR")];
  const sheetRowIndex = (currentPage - 1) * rowsPerPage + localIndex + 2; // baris real di sheet

  if (!resi || !kurir) return alert("Nomor resi atau kurir kosong!");

  try {
    // Ambil tracking dari BinderByte (pastikan API key valid & courier code sesuai kebutuhan server)
    const response = await fetch(
      `https://api.binderbyte.com/v1/track?api_key=7dfb0627d2a03a05e81b82f4565f6b1e1517f280708a6cc9644b58ff6330a793&courier=${kurir}&awb=${resi}`
    );
    if (!response.ok) throw new Error("Gagal fetch BinderByte");

    const result = await response.json();
    const history = result.data?.history || [];
    if (history.length === 0) return alert("Tidak ada history tracking!");

    const last = history[0];
    const lastDesc = last.desc || "";
    const lastDate = last.date || "";
    const status   = result.data.summary?.status || "";

    // Durasi kirim
    let duration = "";
    if (history.length > 1) {
      const start = new Date(history[history.length - 1].date);
      const end   = new Date(history[0].date);
      const diff  = end - start;
      if (!isNaN(diff)) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours < 24) duration = hours + " Jam";
        else {
          const days = Math.floor(hours / 24);
          const hRem = hours % 24;
          duration = `${days} Hari ${hRem} Jam`;
        }
      }
    }

    // Kirim ke GAS pakai JSON (action=updateResi)
    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "updateResi",
        rowIndex: sheetRowIndex,
        lastDesc: lastDesc,
        lastDate: lastDate,
        status: status,
        duration: duration
      })
    });

    // Update lokal pada pageData agar UI langsung berubah
    const idxDesc = headers.indexOf("PELACAKAN TERBARU");
    const idxDate = headers.indexOf("TANGGAL UPDATE");
    const idxStatus = headers.indexOf("STATUS");
    const idxDurasi = headers.indexOf("DURASI KIRIM");

    if (idxDesc >= 0) row[idxDesc] = lastDesc;
    if (idxDate >= 0) row[idxDate] = lastDate;
    if (idxStatus >= 0) row[idxStatus] = status;
    if (idxDurasi >= 0) row[idxDurasi] = duration;

    // Re-calc SINCE LASTUPDATE utk baris ini saja
    hitungSejakDiterima([row]);
    renderTable();

    alert("Resi berhasil diperbarui!");
  } catch (err) {
    console.error(err);
    alert("Terjadi error saat tracking resi: " + err.message);
  }
}

// ===================== INIT =====================
loadData();

// ===================== EXPOSE API UNTUK INLINE HANDLERS =====================
window.App = {
  loadData,
  changePage,
  showEditFull,
  confirmTrackResi,
  trackResi,
  resetFilter
};
</script>

</body>
</html>
