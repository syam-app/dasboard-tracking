<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .table-responsive { overflow-x: auto; }
    .mengecil{font-size: 0.9rem;}
  #searchBox,
  #filterStatus,
  #searchBox::placeholder,
  .search-filter .btn {
    font-size: 0.9rem !important;
  }
  #pagination {
  display: flex;
  justify-content: center; /* posisi tengah */
  flex-wrap: wrap;         /* biar kalau penuh turun ke bawah */
  margin-top: 12px;
  gap: 4px;                /* jarak antar tombol */
}

#pagination .btn {
  padding: 2px 8px;        /* lebih kecil dari default */
  font-size: 0.8rem;       /* perkecil font */
  border-radius: 6px;      /* biar tetap rapi */
}

  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4 fw-bold">ðŸ“¦ Dashboard Tracking</h1>

  <!-- Search & Filter -->
  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-6">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari...">
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Tabel data -->
  <div class="card table-responsive">
    <div class="card-header lead">Data Tracking</div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover mb-0 mengecil" id="dataTable">
        <thead class="table-dark"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
    <div id="pagination" class="mb-4"></div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== CONFIG =====================
const API_URL = "https://script.google.com/macros/s/AKfycbznj-sKwQWMPi8uQSyVm4JzBAWrRnE8te-0p8CAWc9q0mX9Qvbfx8lmcXm37hpFtJa8uQ/exec"; 
let fullData = [];
let columns = [];
let visibleColumns = ["TGL ORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT","NO. RESI","KURIR","PELACAKAN TERBARU","TANGGAL UPDATE","STATUS","DURASI KIRIM"];

// Template pesan WA
const waTemplates = {
  info: "Halo Pak {NAMA}, Pesanan Anda {OBATNYA} dengan nomor resi *{NORESI}* status saat ini *{STATUS}*. *{TRACKING}* di update pada *{TGLUPDATE}*. Terima kasih :)",
  followup: "Halo Pak {NAMA}, Bagaimana perkembangannya setelah konsumsi {OBATNYA}?",
  reminder: "Halo Pak {NAMA}, jangan lupa untuk konfirmasi penerimaan paket Anda ya ðŸ˜Š"
};

// ===================== FUNGSI UTIL =====================
// Format tanggal ISO ke format lokal Indonesia
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; 
  return d.toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit"
  });
}

// Format nomor WhatsApp agar selalu prefix +62
function formatPhone(number) {
  if (!number) return "";
  let cleaned = number.toString().replace(/\D/g,""); 
  if (cleaned.startsWith("62")) return cleaned;
  if (cleaned.startsWith("0")) return "62" + cleaned.slice(1);
  return "62" + cleaned; 
}

// Replace template dengan data row
function fillTemplate(template, row) {
  let text = template;
  columns.forEach((col, i) => {
    text = text.replace(new RegExp("\\{"+col.replace(/\./g,"")+"\\}", "gi"), row[i] || "");
  });
  return text;
}

// ===================== LOAD DATA =====================
function loadData() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      columns = data[0];         
      fullData = data.slice(1);  
      if (visibleColumns.length === 0) visibleColumns = [...columns]; 
      renderFilterOptions();
      renderTable();
    });
}

// ===================== FILTER =====================
function renderFilterOptions() {
  const filter = document.getElementById("filterStatus");
  filter.innerHTML = '<option value="">Filter Status</option>';

  const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
  if (statusIdx >= 0) {
    const statuses = [...new Set(fullData.map(r => r[statusIdx]))].filter(s => s);
    statuses.forEach(s => filter.innerHTML += `<option value="${s}">${s}</option>`);
  }
}
// ===================== PAGINATION =====================
let currentPage = 1;
const rowsPerPage = 10;

function changePage(page) {
  currentPage = page;
  renderTable();
}

// ===================== RENDER TABEL =====================
function renderTable() {
  const thead = document.querySelector("#dataTable thead tr");
  const tbody = document.querySelector("#dataTable tbody");

  thead.innerHTML = "<th>#</th>";
  visibleColumns.forEach(col => thead.innerHTML += `<th>${col}</th>`);
  thead.innerHTML += "<th>AKSI</th>";

  const keyword = document.getElementById("searchBox")?.value.toLowerCase() || "";
  const filterStatus = document.getElementById("filterStatus")?.value || "";

  // ðŸ”¹ 1. Filter data dulu
  let filteredData = fullData.filter((row) => {
    const matchKeyword = keyword === "" || row.some(cell => String(cell).toLowerCase().includes(keyword));
    const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
    const matchStatus = !filterStatus || (statusIdx >= 0 && String(row[statusIdx]) === filterStatus);
    return matchKeyword && matchStatus;
  });

  // ðŸ”¹ 2. Pagination
  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  if (currentPage > totalPages) currentPage = totalPages || 1; // antisipasi kalau data habis

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  // ðŸ”¹ 3. Render baris tabel
  tbody.innerHTML = "";
  pageData.forEach((row, i) => {
    let tr = document.createElement("tr");
    let cells = `<td>${start + i + 1}</td>`; // nomor urut global
    visibleColumns.forEach(col => {
      const idx = columns.indexOf(col);
      let val = row[idx] || "";

      if (col === "TGL ORDER" || col === "TANGGAL UPDATE") {
        val = formatDate(val);
      }
      cells += `<td>${val}</td>`;
    });

    // Tombol aksi
    const rowIndex = fullData.indexOf(row); // biar index sesuai data asli
    cells += `<td>
                <button class="btn btn-sm btn-warning" onclick="showEditFull(${rowIndex})"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-sm btn-success mt-1" onclick="showWaModal(${rowIndex})"><i class="bi bi-whatsapp"></i></button>
                <button class="btn btn-sm btn-primary mt-1" onclick="confirmTrackResi(${rowIndex})"><i class="bi bi-truck"></i></button>
              </td>`;
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });

  // ðŸ”¹ 4. Render pagination controls (smart pagination)
  const paginationEl = document.getElementById("pagination");
  if (paginationEl) {
    paginationEl.innerHTML = "";

    // Tombol First
    paginationEl.innerHTML += `
      <button class="btn btn-sm btn-outline-primary me-1"
        onclick="changePage(1)"
        ${currentPage === 1 ? "disabled" : ""}>First</button>
    `;

    // Tombol Prev
    paginationEl.innerHTML += `
      <button class="btn btn-sm btn-outline-primary me-1"
        onclick="changePage(${currentPage - 1})"
        ${currentPage === 1 ? "disabled" : ""}>Prev</button>
    `;

    // Nomor halaman compact dengan ellipsis
    const maxVisible = 5; // jumlah tombol halaman yg ditampilkan (selain first & last)
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;

    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    // Selalu tampilkan halaman 1
    if (startPage > 1) {
      paginationEl.innerHTML += `
        <button class="btn btn-sm ${currentPage === 1 ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(1)">1</button>`;
      if (startPage > 2) {
        paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
      }
    }

    // Halaman di tengah
    for (let p = startPage; p <= endPage; p++) {
      paginationEl.innerHTML += `
        <button class="btn btn-sm ${p === currentPage ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(${p})">${p}</button>`;
    }

    // Selalu tampilkan halaman terakhir
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
      }
      paginationEl.innerHTML += `
        <button class="btn btn-sm ${currentPage === totalPages ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    // Tombol Next
    paginationEl.innerHTML += `
      <button class="btn btn-sm btn-outline-primary ms-1"
        onclick="changePage(${currentPage + 1})"
        ${currentPage === totalPages ? "disabled" : ""}>Next</button>
    `;

    // Tombol Last
    paginationEl.innerHTML += `
      <button class="btn btn-sm btn-outline-primary ms-1"
        onclick="changePage(${totalPages})"
        ${currentPage === totalPages ? "disabled" : ""}>Last</button>
    `;
  }
}


// ===================== MODAL EDIT =====================
function showEditFull(idx){
  const modalBody = document.querySelector("#editForm .modal-body");
  modalBody.innerHTML = "";
  const dataRow = fullData[idx];

  columns.forEach((col,i)=>{
    const val = dataRow[i] || "";
    const div = document.createElement("div");
    div.className = "mb-3";
    div.innerHTML = `<label>${col}</label>
                     <input type="text" class="form-control" name="${col}" value="${val}">`;
    modalBody.appendChild(div);
  });

  const rowInput = document.createElement("input");
  rowInput.type = "hidden";
  rowInput.name = "row";
  rowInput.value = idx+2; 
  modalBody.appendChild(rowInput);

  new bootstrap.Modal(document.getElementById("editModal")).show();
}

document.getElementById("editForm").addEventListener("submit", function(e){
  e.preventDefault();
  let formData = new FormData(this);
  formData.append("action","update");

  fetch(API_URL, {method:"POST", body:formData})
    .then(res=>res.text())
    .then(msg=>{
      alert(msg);
      loadData();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    });
});

// ===================== MODAL WHATSAPP =====================
function showWaModal(idx) {
  const row = fullData[idx];
  const nama = row[columns.indexOf("NAMA")] || "";
  const noWa = formatPhone(row[columns.indexOf("WHATSAPP")] || "");
  const tglupdate = formatDate(row[columns.indexOf("TANGGAL UPDATE")] || "");
  const resi = row[columns.indexOf("NO. RESI")] || "";
  const obatnya = row[columns.indexOf("BARANG")] || "";
  const tracking = row[columns.indexOf("PELACAKAN TERBARU")] || "";
  const status = row[columns.indexOf("STATUS")] || "";

  const modalId = "waModal";
  let modalEl = document.getElementById(modalId);

  // kalau modal belum ada â†’ buat
  if (!modalEl) {
    modalEl = document.createElement("div");
    modalEl.className = "modal fade";
    modalEl.id = modalId;
    modalEl.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Kirim WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Pesan</label>
            <textarea id="waMessage" class="form-control" rows="4"></textarea>
            <div class="mt-3">
              <label class="form-label">Pilih Template</label>
              <select id="waTemplate" class="form-select">
                <option value="">-- Pilih --</option>
                <option value="info">Info Pesanan</option>
                <option value="followup">Follow Up</option>
                <option value="reminder">Pengingat</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <a id="waSendBtn" target="_blank" class="btn btn-success">Kirim WA</a>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modalEl);
  }

  const textarea = modalEl.querySelector("#waMessage");
  const select = modalEl.querySelector("#waTemplate");
  const sendBtn = modalEl.querySelector("#waSendBtn");

  // Default isi dengan template info
  textarea.value = fillTemplate(waTemplates.info, row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);

  // Ganti pesan jika template dipilih
  select.onchange = () => {
    const tpl = select.value;
    if (waTemplates[tpl]) {
      textarea.value = fillTemplate(waTemplates[tpl], row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);
    }
  };

  // Update tombol kirim
  sendBtn.onclick = () => {
    const pesan = encodeURIComponent(textarea.value);
    window.open(`https://wa.me/${noWa}?text=${pesan}`, "_blank");
  };

  new bootstrap.Modal(modalEl).show();
}

// ===================== TRACK RESI =====================
// Wrapper konfirmasi sebelum panggil trackResi
function confirmTrackResi(i) {
  if (confirm("Yakin mau cek resi untuk data baris ke-" + (i+1) + " ?")) {
    trackResi(i); // kalau OK, baru jalankan fungsi aslinya
  }
}

async function trackResi(idx) {
  const row = fullData[idx];
  const resi = row[columns.indexOf("NO. RESI")];
  const kurir = row[columns.indexOf("KURIR")];
  const rowIndex = idx + 2; // offset header

  if (!resi || !kurir) {
    alert("Nomor resi atau kurir kosong!");
    return;
  }

  try {
    // >>>>>>>>>>>>> Ganti URL API tracking sesuai layanan yang kamu pakai <<<<<<<<<<<<<
    const apiKey = "7dfb0627d2a03a05e81b82f4565f6b1e1517f280708a6cc9644b58ff6330a793";
    const res = await fetch(`https://api.binderbyte.com/v1/track?api_key=${apiKey}&courier=${kurir}&awb=${resi}`);
    const json = await res.json();

    if (json.status !== 200) {
      alert("Gagal tracking resi: " + json.message);
      return;
    }

const hist = json.data.history[0] || {};
const lastDesc = hist.desc || "";
const lastDate = hist.date || "";
const status = json.data.summary.status || "";

// Durasi = history terbaru - history pertama
let duration = "";
if (json.data.history && json.data.history.length > 1) {
  const firstHist = json.data.history[json.data.history.length - 1]; // paling awal
  const lastHist = json.data.history[0]; // terbaru
  const firstDate = new Date(firstHist.date);
  const lastDateObj = new Date(lastHist.date);

  const diffMs = lastDateObj - firstDate; // selisih dalam ms
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

  if (diffHours < 24) {
    duration = diffHours + " Jam";
  } else {
    const days = Math.floor(diffHours / 24);
    const hours = diffHours % 24;
    duration = days + " Hari " + hours + " Jam";
  }
}


    // update ke GAS
    const payload = {
      action: "updateResi",
      rowIndex: rowIndex,
      lastDesc: lastDesc,
      lastDate: lastDate,
      status: status,
      duration: duration
    };

    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    alert("Resi berhasil diperbarui!");
    loadData();
  } catch (err) {
    console.error(err);
    alert("Error saat tracking resi");
  }
}

// ===================== FILTER ACTION =====================
document.getElementById("searchBox").addEventListener("input", renderTable);
document.getElementById("filterStatus").addEventListener("change", renderTable);
function resetFilter() {
  document.getElementById("searchBox").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
}

// ===================== INIT =====================
loadData();
</script>

</body>
</html>
