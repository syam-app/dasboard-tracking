<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .table-responsive { overflow-x: auto; }
    .mengecil{font-size: 0.9rem;}
    #searchBox,
    #filterStatus,
    #searchBox::placeholder,
    .search-filter .btn {
      font-size: 0.9rem !important;
    }
    #pagination {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 12px;
      gap: 4px;
    }
    #pagination .btn {
      padding: 2px 8px;
      font-size: 0.8rem;
      border-radius: 6px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4 fw-bold">ðŸ“¦ Dashboard Tracking</h1>

  <!-- Search & Filter -->
  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-6">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari...">
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Tabel data -->
  <div class="card table-responsive">
    <div class="card-header lead">Data Tracking</div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover mb-0 mengecil" id="dataTable">
        <thead class="table-dark"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<div id="pagination" class="mb-4"></div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== CONFIG =====================
const API_URL = "https://script.google.com/macros/s/AKfycbybIaPmHgwM82X_1kKgsH7Yk_lIMcVdfxDXy-VUEw4wrdRRITqK_UQP-ooSz8z6ySt2CQ/exec"; 
let fullData = [];
let columns = [];
let serverColumns = []; // header asli dari sheet
let visibleColumns = ["TGL ORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT","NO. RESI","KURIR","PELACAKAN TERBARU","TANGGAL UPDATE","STATUS","DURASI KIRIM","SINCE LASTUPDATE"];

// Template pesan WA
const waTemplates = {
  infopesanan: `*DATA PESANAN*
_{TGLORDER}_
-------------------
_*Info Pemesan*_
{NAMA} | 62{WHATSAPP}
{DETAIL ALAMAT}
{ALAMAT}

_*Info Pesanan*_
{OBATNYA}
Pembayaran {PAYMENT}
  
_*Info Pengiriman*_
No. Resi  : {NORESI}
Ekspedisi : {KURIRE}`,
  infotracking: "Halo Pak/Bu {NAMA}, Pesanan Anda {OBATNYA} dengan nomor resi *{NORESI}* status saat ini *{STATUS}*. *{TRACKING}* di update pada *{TGLUPDATE}*. Terima kasih :)",
  followup: "Halo Pak/Bu {NAMA}, Bagaimana perkembangannya setelah konsumsi {OBATNYA}?",
  reminder: "Halo Pak/Bu {NAMA}, jangan lupa untuk konfirmasi penerimaan paket Anda ya ðŸ˜Š",
  invoice: `*DATA PESANAN*
---------------------------------------------
_{TGLORDER}_

_*Info Pemesan*_
{NAMA} | 62{WHATSAPP}
{DETAIL ALAMAT}
{ALAMAT}

_*Info Pesanan*_
{OBATNYA}
Pembayaran {PAYMENT}
  
_*Info Pengiriman*_
No. Resi  : {NORESI}
Ekspedisi : {KURIRE}
~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~

*INVOICE*
---------------------------------------------
_Kepada Pak/Bu {NAMA}_

_*Ringkasan Pesanan*_
- {ITEMS}

_*Ringkasan Tagihan*_
- Subtotal Obat    : Rp {SUBTOTAL}
- Ongkir               : Rp {ONGKIR}
- Diskon Obat      : ~Rp {DISKON_OBAT}~
- Diskon Ongkir   : ~Rp {DISKON_ONGKIR}~

> Anda hemat Rp {HEMAT}
--------------------------------------
*Total Tagihan COD : Rp {TOTAL}*`
};

// ===================== FUNGSI UTIL =====================
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; 
  return d.toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit"
  });
}
function formatPhone(number) {
  if (!number) return "";
  let cleaned = number.toString().replace(/\D/g,""); 
  if (cleaned.startsWith("62")) return cleaned;
  if (cleaned.startsWith("0")) return "62" + cleaned.slice(1);
  return "62" + cleaned; 
}
function fillTemplate(template, row) {
  let text = template;
  columns.forEach((col, i) => {
    text = text.replace(new RegExp("\\{"+col.replace(/\./g,"")+"\\}", "gi"), row[i] || "");
  });
  return text;
}

// ===================== LOAD DATA =====================
function loadData() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      columns = data[0];         
      serverColumns = [...columns]; // simpan header asli

      // simpan nomor baris asli
      fullData = data.slice(1).map((row, i) => {
        const r = [...row];
        r._row = i + 2; // baris real di sheet
        return r;
      });

      hitungSejakDiterima();  
      const idxUpdate = columns.indexOf("TGL ORDER");
      if (idxUpdate >= 0) {
        fullData.sort((a, b) => new Date(b[idxUpdate]) - new Date(a[idxUpdate]));
      }
      if (visibleColumns.length === 0) visibleColumns = [...columns]; 
      renderFilterOptions();
      renderTable();
    });
}
function hitungSejakDiterima() {
  const idxUpdate = columns.indexOf("TANGGAL UPDATE");
  let idxSejak = columns.indexOf("SINCE LASTUPDATE");
  if (idxSejak === -1) {
    columns.push("SINCE LASTUPDATE");
    idxSejak = columns.length - 1;
  }
  const now = new Date();
  fullData.forEach(row => {
    const tglUpdate = new Date(row[idxUpdate]);
    if (!isNaN(tglUpdate)) {
      const diffMs = now - tglUpdate;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60)); 
      const days = Math.floor(diffHours / 24);
      const hours = diffHours % 24;
      let result = "";
      if (days > 0) result += days + " Hari";
      if (hours > 0) result += (result ? " " : "") + hours + " Jam";
      row[idxSejak] = (result || "0 Jam") + " yang lalu";
    } else {
      row[idxSejak] = "";
    }
  });
}

// ===================== FILTER =====================
function renderFilterOptions() {
  const filter = document.getElementById("filterStatus");
  filter.innerHTML = '<option value="">Filter Status</option>';
  const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
  if (statusIdx >= 0) {
    const statuses = [...new Set(fullData.map(r => r[statusIdx]))].filter(s => s);
    statuses.forEach(s => filter.innerHTML += `<option value="${s}">${s}</option>`);
  }
}
// ===================== PAGINATION =====================
let currentPage = 1;
const rowsPerPage = 10;
function changePage(page) {
  currentPage = page;
  renderTable();
}

// ===================== RENDER TABEL =====================
function renderTable() {
  const thead = document.querySelector("#dataTable thead tr");
  const tbody = document.querySelector("#dataTable tbody");
  thead.innerHTML = "<th>#</th>";
  visibleColumns.forEach(col => thead.innerHTML += `<th>${col}</th>`);
  thead.innerHTML += "<th>AKSI</th>";

  const keyword = document.getElementById("searchBox")?.value.toLowerCase() || "";
  const filterStatus = document.getElementById("filterStatus")?.value || "";
  let filteredData = fullData.filter((row) => {
    const matchKeyword = keyword === "" || row.some(cell => String(cell).toLowerCase().includes(keyword));
    const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
    const matchStatus = !filterStatus || (statusIdx >= 0 && String(row[statusIdx]) === filterStatus);
    return matchKeyword && matchStatus;
  });

  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  if (currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  tbody.innerHTML = "";
  pageData.forEach((row, i) => {
    let tr = document.createElement("tr");
    let cells = `<td>${start + i + 1}</td>`;
    visibleColumns.forEach(col => {
      const idx = columns.indexOf(col);
      let val = row[idx] || "";
      if (col === "TGL ORDER" || col === "TANGGAL UPDATE") {
        val = formatDate(val);
      }
      cells += `<td>${val}</td>`;
    });
    const rowIndex = fullData.indexOf(row);
    cells += `<td>
                <button class="btn btn-sm btn-warning" onclick="showEditFull(${rowIndex})"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-sm btn-success mt-1" onclick="showWaModal(${rowIndex})"><i class="bi bi-whatsapp"></i></button>
                <button class="btn btn-sm btn-primary mt-1" onclick="confirmTrackResi(${rowIndex})"><i class="bi bi-truck"></i></button>
              </td>`;
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });

  // pagination (tidak diubah)
  const paginationEl = document.getElementById("pagination");
  if (paginationEl) {
    paginationEl.innerHTML = "";
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary me-1"
        onclick="changePage(1)" ${currentPage === 1 ? "disabled" : ""}>First</button>`;
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary me-1"
        onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>Prev</button>`;
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;
    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = Math.max(1, endPage - maxVisible + 1);
    }
    if (startPage > 1) {
      paginationEl.innerHTML += `<button class="btn btn-sm ${currentPage === 1 ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(1)">1</button>`;
      if (startPage > 2) {
        paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
      }
    }
    for (let p = startPage; p <= endPage; p++) {
      paginationEl.innerHTML += `<button class="btn btn-sm ${p === currentPage ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(${p})">${p}</button>`;
    }
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationEl.innerHTML += `<span class="px-2">â€¦</span>`;
      }
      paginationEl.innerHTML += `<button class="btn btn-sm ${currentPage === totalPages ? 'btn-primary' : 'btn-outline-primary'}"
          onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary ms-1"
        onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>Next</button>`;
    paginationEl.innerHTML += `<button class="btn btn-sm btn-outline-primary ms-1"
        onclick="changePage(${totalPages})" ${currentPage === totalPages ? "disabled" : ""}>Last</button>`;
  }
}

// ===================== MODAL EDIT =====================
function showEditFull(idx){
  const modalBody = document.querySelector("#editForm .modal-body");
  modalBody.innerHTML = "";
  const dataRow = fullData[idx];
  serverColumns.forEach((col,i)=>{
    const val = dataRow[i] || "";
    const div = document.createElement("div");
    div.className = "mb-3";
    div.innerHTML = `<label>${col}</label>
                     <input type="text" class="form-control" name="${col}" value="${val}">`;
    modalBody.appendChild(div);
  });
  const rowInput = document.createElement("input");
  rowInput.type = "hidden";
  rowInput.name = "row";
  rowInput.value = dataRow._row; // nomor baris asli
  modalBody.appendChild(rowInput);
  new bootstrap.Modal(document.getElementById("editModal")).show();
}
document.getElementById("editForm").addEventListener("submit", function(e){
  e.preventDefault();
  let formData = new FormData(this);
  formData.append("action","update");
  fetch(API_URL, {method:"POST", body:formData})
    .then(res=>res.text())
    .then(msg=>{
      alert(msg);
      loadData();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    });
});

// ================= Helper =================
function parseObat(obatValue, hargaSatuan) {
  if (!obatValue) return { qty: 1, namaProduk: "", itemsText: "", subtotal: 0 };
  const parts = obatValue.trim().split(/\s+/);
  const qty = parseInt(parts[0], 10) || 1;      // contoh: "3 Botol ..."
  const namaProduk = parts.slice(2).join(" ");  // ambil setelah kata "Botol"
  const itemsText = `${namaProduk}   x ${qty}`;
  const subtotal = qty * (Number(hargaSatuan) || 0);
  return { qty, namaProduk, itemsText, subtotal };
}

function parseRupiah(str) {
  if (!str) return 0;
  return parseInt(
    String(str)
      .replace(/Rp/g, "")
      .replace(/\s/g, "")
      .replace(/\./g, "")
      .replace(/,/g, "")
      .replace(/~/g, "")
  ) || 0;
}

function formatRupiah(num) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0
  }).format(Number(num) || 0);
}
function formatKurir(code) {
  if (!code) return "";
  const map = {
    spx: "SPX Express",
    jnt: "J&T Express",
    jne: "JNE Express",
    ninja: "NINJA Express",
    ide: "ID Express"
  };
  const key = code.toLowerCase().trim();
  return map[key] || code; // kalau tidak ada di map, pakai aslinya
}


// ================= Update invoice dari input angka =================
function refreshInvoiceFields(textarea, fields, obatnya, hargaSatuan) {
  // qty & subtotal dihitung dari BARANG via parseObat
  const { subtotal } = parseObat(obatnya, hargaSatuan);

  const ongkir = parseInt(fields.ongkir.value, 10) || 0;
  const diskonObat = parseInt(fields.diskonObat.value, 10) || 0;
  const diskonOngkir = parseInt(fields.diskonOngkir.value, 10) || 0;

  const hemat = diskonObat + diskonOngkir;
  const total = subtotal + ongkir - hemat;

  let text = textarea.value;

  // Subtotal (hindari "Rp Rp": biarkan formatRupiah yang menulis "Rp")
  text = text.replace(/- Subtotal Obat\s*:\s*Rp[^\n]*/i, `- Subtotal Obat   : ${formatRupiah(subtotal)}`);
  // Ongkir
  text = text.replace(/- Ongkir\s*:\s*Rp[^\n]*/i, `- Ongkir               : ${formatRupiah(ongkir)}`);
  // Diskon Obat (dengan ~ ~)
  text = text.replace(/- Diskon Obat\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Obat     : ~${formatRupiah(diskonObat)}~`);
  // Diskon Ongkir
  text = text.replace(/- Diskon Ongkir\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Ongkir  : ~${formatRupiah(diskonOngkir)}~`);
  // Hemat
  text = text.replace(/^> *Anda hemat.*$/mi, `> Anda hemat ${formatRupiah(hemat)}`);
  // Total (normalkan agar hanya satu pasang * â€¦ *)
  text = text.replace(/^\**\s*Total Tagihan COD\s*:?\s*Rp[^\n]*\**$/mi, `*Total Tagihan COD ${formatRupiah(total)}*`);

  textarea.value = text;
}

// ================= Modal WhatsApp =================
function showWaModal(idx) {
  const row = fullData[idx];
  const nama = row[columns.indexOf("NAMA")] || "";
  const noWa = formatPhone(row[columns.indexOf("WHATSAPP")] || "");
  const tglupdate = formatDate(row[columns.indexOf("TANGGAL UPDATE")] || "");
  const tglorder = formatDate(row[columns.indexOf("TGL ORDER")] || "");
  const resi = row[columns.indexOf("NO. RESI")] || "";
  const obatnya = row[columns.indexOf("BARANG")] || "";
  const kurir = row[columns.indexOf("KURIR")] || "";
  const tracking = row[columns.indexOf("PELACAKAN TERBARU")] || "";
  const status = row[columns.indexOf("STATUS")] || "";

  const modalId = "waModal";
  let modalEl = document.getElementById(modalId);

  if (!modalEl) {
    modalEl = document.createElement("div");
    modalEl.className = "modal fade";
    modalEl.id = modalId;
    modalEl.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Kirim WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Pesan</label>
            <textarea id="waMessage" class="form-control" rows="7"></textarea>
            
            <div class="mt-3">
              <label class="form-label">Pilih Template</label>
              <select id="waTemplate" class="form-select">
                <option value="">-- Pilih --</option>
                <option value="invoice">Invoice</option>
                <option value="infopesanan">Info Pesanan</option>
                <option value="infotracking">Info Tracking</option>
                <option value="followup">Follow Up</option>
                <option value="reminder">Pengingat</option>
              </select>
            </div>

            <!-- Input tambahan khusus invoice -->
            <div id="invoiceFields" class="mt-3" style="display:none;">
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Ongkir</label>
                  <input type="number" id="invOngkir" class="form-control" value="0" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Diskon Obat</label>
                  <input type="number" id="invDiskonObat" class="form-control" value="0" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Diskon Ongkir</label>
                  <input type="number" id="invDiskonOngkir" class="form-control" value="0" min="0">
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <a id="waSendBtn" target="_blank" class="btn btn-success">Kirim WA</a>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modalEl);
  }

  const textarea = modalEl.querySelector("#waMessage");
  const select = modalEl.querySelector("#waTemplate");
  const sendBtn = modalEl.querySelector("#waSendBtn");

  const invoiceFields = {
    container: modalEl.querySelector("#invoiceFields"),
    ongkir: modalEl.querySelector("#invOngkir"),
    diskonObat: modalEl.querySelector("#invDiskonObat"),
    diskonOngkir: modalEl.querySelector("#invDiskonOngkir"),
  };

  const hargaSatuan = 269000; // atur sesuai produk

  // Default isi template info
  textarea.value = fillTemplate(waTemplates.infopesanan, row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TGLORDER}", tglorder)
    .replace("{KURIRE}", formatKurir(kurir))
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);

  // === saat pilih template ===
  select.onchange = () => {
    if (select.value === "invoice") {
      invoiceFields.container.style.display = "block";

      const { itemsText, subtotal } = parseObat(obatnya, hargaSatuan);
      const ongkir = parseInt(invoiceFields.ongkir.value, 10) || 0;
      const diskonObat = parseInt(invoiceFields.diskonObat.value, 10) || 0;
      const diskonOngkir = parseInt(invoiceFields.diskonOngkir.value, 10) || 0;
      const hemat = diskonObat + diskonOngkir;
      const total = subtotal + ongkir - hemat;

      textarea.value = fillTemplate(waTemplates.invoice, row)
        .replace("{TGLORDER}", tglorder)
        .replace("{NAMA}", nama)
        .replace("{ITEMS}", itemsText)
        .replace("{NORESI}", resi)
        .replace("{OBATNYA}", obatnya)
        .replace("{SUBTOTAL}", formatRupiah(subtotal))
        .replace("{ONGKIR}", formatRupiah(ongkir))
        .replace("{DISKON_OBAT}", formatRupiah(diskonObat))
        .replace("{KURIRE}", formatKurir(kurir))
        .replace("{DISKON_ONGKIR}", formatRupiah(diskonOngkir))
        .replace("{HEMAT}", formatRupiah(hemat))
        .replace("{TOTAL}", formatRupiah(total));

      // re-calc saat input angka diubah
      [invoiceFields.ongkir, invoiceFields.diskonObat, invoiceFields.diskonOngkir].forEach(el => {
        el.oninput = () => {
          refreshInvoiceFields(textarea, invoiceFields, obatnya, hargaSatuan);
        };
      });

    } else if (waTemplates[select.value]) {
      invoiceFields.container.style.display = "none";
      textarea.value = fillTemplate(waTemplates[select.value], row)
        .replace("{NAMA}", nama)
        .replace("{NORESI}", resi)
        .replace("{OBATNYA}", obatnya)
        .replace("{TGLUPDATE}", tglupdate)
        .replace("{TGLORDER}", tglorder)
        .replace("{KURIRE}", formatKurir(kurir))
        .replace("{TRACKING}", tracking)
        .replace("{STATUS}", status);
    }
  };

  // === tombol kirim hanya buka WA ===
  sendBtn.onclick = () => {
    const pesan = encodeURIComponent(textarea.value);
    window.open(`https://wa.me/${noWa}?text=${pesan}`, "_blank");
  };

  new bootstrap.Modal(modalEl).show();
}


// ===================== TRACK RESI =====================
function confirmTrackResi(i) {
  if (confirm("Yakin mau cek resi untuk data baris ke-" + (i+1) + " ?")) {
    trackResi(i);
  }
}
async function trackResi(idx) {
  const row = fullData[idx];
  const resi = row[columns.indexOf("NO. RESI")];
  const kurir = row[columns.indexOf("KURIR")];
  const rowIndex = row._row; // nomor baris asli di sheet

  if (!resi || !kurir) {
    alert("Nomor resi atau kurir kosong!");
    return;
  }

  try {
    // 1) Ambil tracking dari BinderByte
    const response = await fetch(
      `https://api.binderbyte.com/v1/track?api_key=7dfb0627d2a03a05e81b82f4565f6b1e1517f280708a6cc9644b58ff6330a793&courier=${kurir}&awb=${resi}`
    );
    if (!response.ok) throw new Error("Gagal fetch BinderByte");

    const result = await response.json();
    const history = result.data?.history || [];
    if (history.length === 0) {
      alert("Tidak ada history tracking!");
      return;
    }

    // 2) Data terbaru
    const last = history[0];
    const lastDesc = last.desc || "";
    const lastDate = last.date || "";
    const status   = result.data.summary?.status || "";

// 3) Durasi kirim: tanggal history pertama â†’ tanggal history terbaru
let duration = "";
if (history.length > 1) {
  const start = new Date(history[history.length - 1].date); // paling awal
  const end   = new Date(history[0].date);                  // terbaru
  const diff  = end - start;

  if (!isNaN(diff)) {
    const hours = Math.floor(diff / (1000 * 60 * 60));
    if (hours < 24) {
      duration = hours + " Jam";
    } else {
      const days = Math.floor(hours / 24);
      const hRem = hours % 24;
      duration = `${days} Hari ${hRem} Jam`;
    }
  }
}


    // 4) Kirim ke GAS pakai FormData (action=update) â†’ anti CORS preflight
    const fd = new FormData();
    fd.append("action", "update");
    fd.append("row", rowIndex);

    // Isi semua kolom sesuai header asli, tapi timpa 4 kolom target
    serverColumns.forEach((h, i) => {
      let v = row[i] ?? ""; // nilai lama
      if (h === "PELACAKAN TERBARU") v = lastDesc;
      if (h === "TANGGAL UPDATE")    v = lastDate;
      if (h === "STATUS")            v = status;
      if (h === "DURASI KIRIM")      v = duration;
      fd.append(h, v);
    });

    await fetch(API_URL, { method: "POST", body: fd });

    alert("Resi berhasil diperbarui!");
    loadData(); // refresh tabel
  } catch (err) {
    console.error(err);
    alert("Terjadi error saat tracking resi: " + err.message);
  }
}


// ===================== FILTER ACTION =====================
document.getElementById("searchBox").addEventListener("input", renderTable);
document.getElementById("filterStatus").addEventListener("change", renderTable);
function resetFilter() {
  document.getElementById("searchBox").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
}

// ===================== INIT =====================
loadData();
</script>

</body>
</html>
