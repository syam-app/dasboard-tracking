<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">ðŸ“¦ Dashboard Tracking</h1>

  <!-- Search & Filter -->
  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-6">
        <input type="text" id="searchBox" class="form-control" placeholder="Cari...">
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Tabel data -->
  <div class="card table-responsive mb-4">
    <div class="card-header">Data Tracking</div>
    <div class="card-body p-0">
      <table class="table table-bordered table-hover mb-0" id="dataTable">
        <thead class="table-dark"><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== CONFIG =====================
const API_URL = "https://script.google.com/macros/s/AKfycbzB7aCsWp8hznss2sLW7EUtx4zAuBGqa-HcuBs2vihEqdTAP6Fc4JGuDWblp-VThmGoyA/exec"; 
let fullData = [];
let columns = [];
let visibleColumns = ["TGL ORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT","NO. RESI","PELACAKAN TERBARU","TANGGAL UPDATE","STATUS","DURASI KIRIM"];

// Template pesan WA
const waTemplates = {
  info: "Halo Pak {NAMA}, Pesanan Anda {OBATNYA} dengan nomor resi *{NORESI}* status saat ini *{STATUS}*. *{TRACKING}* di update pada *{TGLUPDATE}*. Terima kasih :)",
  followup: "Halo Pak {NAMA}, Bagaimana perkembangannya setelah konsumsi {OBATNYA}?",
  reminder: "Halo Pak {NAMA}, jangan lupa untuk konfirmasi penerimaan paket Anda ya ðŸ˜Š"
};

// ===================== FUNGSI UTIL =====================
// Format tanggal ISO ke format lokal Indonesia
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; 
  return d.toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit"
  });
}

// Format nomor WhatsApp agar selalu prefix +62
function formatPhone(number) {
  if (!number) return "";
  let cleaned = number.toString().replace(/\D/g,""); 
  if (cleaned.startsWith("62")) return cleaned;
  if (cleaned.startsWith("0")) return "62" + cleaned.slice(1);
  return "62" + cleaned; 
}

// Replace template dengan data row
function fillTemplate(template, row) {
  let text = template;
  columns.forEach((col, i) => {
    text = text.replace(new RegExp("\\{"+col.replace(/\./g,"")+"\\}", "gi"), row[i] || "");
  });
  return text;
}

// ===================== LOAD DATA =====================
function loadData() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      columns = data[0];         
      fullData = data.slice(1);  
      if (visibleColumns.length === 0) visibleColumns = [...columns]; 
      renderFilterOptions();
      renderTable();
    });
}

// ===================== FILTER =====================
function renderFilterOptions() {
  const filter = document.getElementById("filterStatus");
  filter.innerHTML = '<option value="">Filter Status</option>';

  const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
  if (statusIdx >= 0) {
    const statuses = [...new Set(fullData.map(r => r[statusIdx]))].filter(s => s);
    statuses.forEach(s => filter.innerHTML += `<option value="${s}">${s}</option>`);
  }
}

// ===================== RENDER TABEL =====================
function renderTable() {
  const thead = document.querySelector("#dataTable thead tr");
  const tbody = document.querySelector("#dataTable tbody");

  thead.innerHTML = "<th>#</th>";
  visibleColumns.forEach(col => thead.innerHTML += `<th>${col}</th>`);
  thead.innerHTML += "<th>AKSI</th>";

  const keyword = document.getElementById("searchBox")?.value.toLowerCase() || "";
  const filterStatus = document.getElementById("filterStatus")?.value || "";

  tbody.innerHTML = "";
  fullData.forEach((row, i) => {
    const matchKeyword = keyword === "" || row.some(cell => String(cell).toLowerCase().includes(keyword));
    const statusIdx = columns.findIndex(c => c.toLowerCase() === "status");
    const matchStatus = !filterStatus || (statusIdx >= 0 && String(row[statusIdx]) === filterStatus);

    if (!matchKeyword || !matchStatus) return;

    let tr = document.createElement("tr");
    let cells = `<td>${i+1}</td>`;
    visibleColumns.forEach(col => {
      const idx = columns.indexOf(col);
      let val = row[idx] || "";

      // Format tanggal untuk kolom tertentu
      if (col === "TGL ORDER" || col === "TANGGAL UPDATE") {
        val = formatDate(val);
      }
      cells += `<td>${val}</td>`;
    });

    // Tombol aksi
    cells += `<td>
                <button class="btn btn-sm btn-warning" onclick="showEditFull(${i})"><i class="bi bi-pencil-fill"></i> Edit</button>
                <button class="btn btn-sm btn-success mt-1" onclick="showWaModal(${i})"><i class="bi bi-whatsapp"></i> WA</button>
              </td>`;
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

// ===================== MODAL EDIT =====================
function showEditFull(idx){
  const modalBody = document.querySelector("#editForm .modal-body");
  modalBody.innerHTML = "";
  const dataRow = fullData[idx];

  columns.forEach((col,i)=>{
    const val = dataRow[i] || "";
    const div = document.createElement("div");
    div.className = "mb-3";
    div.innerHTML = `<label>${col}</label>
                     <input type="text" class="form-control" name="${col}" value="${val}">`;
    modalBody.appendChild(div);
  });

  const rowInput = document.createElement("input");
  rowInput.type = "hidden";
  rowInput.name = "row";
  rowInput.value = idx+2; 
  modalBody.appendChild(rowInput);

  new bootstrap.Modal(document.getElementById("editModal")).show();
}

document.getElementById("editForm").addEventListener("submit", function(e){
  e.preventDefault();
  let formData = new FormData(this);
  formData.append("action","update");

  fetch(API_URL, {method:"POST", body:formData})
    .then(res=>res.text())
    .then(msg=>{
      alert(msg);
      loadData();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    });
});

// ===================== MODAL WHATSAPP =====================
function showWaModal(idx) {
  const row = fullData[idx];
  const nama = row[columns.indexOf("NAMA")] || "";
  const noWa = formatPhone(row[columns.indexOf("WHATSAPP")] || "");
  const tglupdate = formatDate(row[columns.indexOf("TANGGAL UPDATE")] || "");
  const resi = row[columns.indexOf("NO. RESI")] || "";
  const obatnya = row[columns.indexOf("BARANG")] || "";
  const tracking = row[columns.indexOf("PELACAKAN TERBARU")] || "";
  const status = row[columns.indexOf("STATUS")] || "";

  const modalId = "waModal";
  let modalEl = document.getElementById(modalId);

  // kalau modal belum ada â†’ buat
  if (!modalEl) {
    modalEl = document.createElement("div");
    modalEl.className = "modal fade";
    modalEl.id = modalId;
    modalEl.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Kirim WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Pesan</label>
            <textarea id="waMessage" class="form-control" rows="4"></textarea>
            <div class="mt-3">
              <label class="form-label">Pilih Template</label>
              <select id="waTemplate" class="form-select">
                <option value="">-- Pilih --</option>
                <option value="info">Info Pesanan</option>
                <option value="followup">Follow Up</option>
                <option value="reminder">Pengingat</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <a id="waSendBtn" target="_blank" class="btn btn-success">Kirim WA</a>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modalEl);
  }

  const textarea = modalEl.querySelector("#waMessage");
  const select = modalEl.querySelector("#waTemplate");
  const sendBtn = modalEl.querySelector("#waSendBtn");

  // Default isi dengan template info
  textarea.value = fillTemplate(waTemplates.info, row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);

  // Ganti pesan jika template dipilih
  select.onchange = () => {
    const tpl = select.value;
    if (waTemplates[tpl]) {
      textarea.value = fillTemplate(waTemplates[tpl], row)
    .replace("{NAMA}", nama)
    .replace("{NORESI}", resi)
    .replace("{OBATNYA}", obatnya)
    .replace("{TGLUPDATE}", tglupdate)
    .replace("{TRACKING}", tracking)
    .replace("{STATUS}", status);
    }
  };

  // Update tombol kirim
  sendBtn.onclick = () => {
    const pesan = encodeURIComponent(textarea.value);
    window.open(`https://wa.me/${noWa}?text=${pesan}`, "_blank");
  };

  new bootstrap.Modal(modalEl).show();
}

// ===================== FILTER ACTION =====================
document.getElementById("searchBox").addEventListener("input", renderTable);
document.getElementById("filterStatus").addEventListener("change", renderTable);
function resetFilter() {
  document.getElementById("searchBox").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
}

// ===================== INIT =====================
loadData();
</script>




</body>
</html>
