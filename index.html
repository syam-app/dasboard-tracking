<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8fafc; }
    .card { border-radius: 1rem; }
    .table th, .table td { vertical-align: middle; }
    .btn { border-radius: .75rem; }
    *{font-size:.9rem ;}
    /* Atur lebar kolom "ALAMAT" */
#dataTable th:nth-child(6), 
#dataTable td:nth-child(6) {
  min-width: 250px;   /* lebar minimum */
  max-width: 350px;   /* biar gak kepanjangan */
  white-space: normal; /* biar bisa wrap ke bawah */
  word-break: break-word; /* pecah kata panjang */
}
.pagination li a, 
.pagination li span {
  font-size: 12px;      /* kecilin font */
  padding: 3px 8px;     /* kecilin tombol */
}

  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0 fw-bold">Dashboard Order</h3>
    <div class="small text-muted">Realtime db • <span id="totalRowsLabel">0</span> Data</div>
  </div>

  <!-- Controls -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3 col-6 col-lg-2">
          <label class="form-label mb-1">Pencarian</label>
          <input id="searchBox" class="form-control" placeholder="Nama, resi, kurir, status, dll..." />
        </div>
        <div class="col-md-2 col-6 col-lg-2">
          <label class="form-label mb-1">Filter Status</label>
          <select id="filterStatus" class="form-select">
            <option value="">Semua Status</option>
            <!-- opsi dinamis terisi saat load -->
          </select>
        </div>
        <div class="col-lg-6">
        <div class="row">
          <div class="col-6">
            <label>Dari:</label>
            <input type="date" id="dateStart" class="form-control">
          </div>
          <div class="col-6">
            <label>Sampai:</label>
            <input type="date" id="dateEnd" class="form-control">
          </div>
        </div></div>
        <div class="col-md-2">
          <label class="form-label mb-1">Baris / Hal</label>
          <select id="rowsPerPage" class="form-select">
            <option>5</option>
            <option>10</option>
            <option>25</option>
            <option>50</option>
          </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-primary w-100" id="btnRefresh"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
          <button class="btn btn-outline-secondary w-100" id="btnReset"><i class="bi bi-eraser me-1"></i>Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered table-striped m-0" id="dataTable">
        <thead class="table-light">
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="container">
      <div class="row align-items-end">
        <div class="col-md-4 mt-2">
          <strong>Total Profit: </strong><br>
          <span id="totalProfit">Rp0</span>
        </div>
        <div class="card-body col-md-8">
          <div id="pagination" class="d-flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal: Edit -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <form class="modal-content" id="editForm">
      <div class="modal-header">
        <h5 class="modal-title">Edit Data Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <!-- fields injected by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: WhatsApp -->
<div class="modal fade" id="waModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kirim WhatsApp</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Pesan</label>
        <textarea id="waMessage" class="form-control" rows="7"></textarea>

        <div class="row g-2 align-items-end mt-3">
          <div class="col-md-6">
            <label class="form-label">Pilih Template</label>
            <select id="waTemplate" class="form-select">
              <option value="">— Pilih —</option>
              <option value="invoice">Invoice</option>
              <option value="infopesanan">Info Pesanan</option>
              <option value="infotracking">Info Tracking</option>
              <option value="followup">Follow Up</option>
              <option value="reminder">Pengingat</option>
            </select>
          </div>
          <div class="col-md-6" id="invoiceFields" style="display:none;">
            <div class="row g-2">
              <div class="col-4">
                <label class="form-label">Ongkir</label>
                <input type="number" id="invOngkir" class="form-control" value="0" min="0">
              </div>
              <div class="col-4">
                <label class="form-label">Diskon Obat</label>
                <input type="number" id="invDiskonObat" class="form-control" value="0" min="0">
              </div>
              <div class="col-4">
                <label class="form-label">Diskon Ongkir</label>
                <input type="number" id="invDiskonOngkir" class="form-control" value="0" min="0">
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <a id="waSendBtn" target="_blank" class="btn btn-success"><i class="bi bi-send me-1"></i>Kirim WA</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- App -->
<script type="module">
/* ===================== 1) Firebase ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getDatabase, ref, get, update, remove 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB8T6K60Er26gh32FegI0a5x0M_Opr9HYY",
  authDomain: "nakara-db.firebaseapp.com",
  databaseURL: "https://nakara-db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nakara-db",
  storageBucket: "nakara-db.firebasestorage.app",
  messagingSenderId: "145693955066",
  appId: "1:145693955066:web:f65286af5d67edbb3f4a43",
  measurementId: "G-S4XV4NFETH"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===================== 2) Konstanta & State ===================== */
const HEADERS = [
  "TGLORDER","NAMA","WHATSAPP","BARANG","ALAMAT","DETAILALAMAT","PAYMENT",
  "NORESI","KURIR","PELACAKANTERBARU","TANGGALUPDATE","STATUS","DURASIKIRIM","MODAL","OMSET","PROFIT"
];
let VISIBLE_COLUMNS = [
  "TGLORDER","NAMA","WHATSAPP","BARANG","ALAMAT","PAYMENT",
  "NORESI","KURIR","PELACAKANTERBARU","TANGGALUPDATE","STATUS",
  "DURASIKIRIM","LASTUPDATE","PROFIT"
];

const WATemplates = {
  infopesanan: "Halo Pak/Bu {NAMA}, pesanan Anda *{OBATNYA}* pada tanggal {TGLORDER} sudah diproses & segera dikirimkan menggunakan ekspedisi {KURIRE} dengan No. Resi *{NORESI}*.",
  infotracking: "Halo Pak/Bu {NAMA}, Pesanan Anda {OBATNYA} dengan nomor resi *{NORESI}* status saat ini {STATUS}. *{TRACKING}* di update pada *{TGLUPDATE}*. Terima kasih :)",
  followup: "Halo Pak/Bu {NAMA}, Bagaimana perkembangannya setelah konsumsi {OBATNYA}?",
  invoice: `*DATA PESANAN*
---------------------------------------------
_{TGLORDER}_

_*Info Pemesan*_
{NAMA} | 62{WHATSAPP}
{DETAILALAMAT}
{ALAMAT}

_*Info Pesanan*_
{OBATNYA}
Pembayaran {PAYMENT}
  
_*Info Pengiriman*_
No. Resi  : {NORESI}
Ekspedisi : {KURIRE}
~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~

*INVOICE*
---------------------------------------------
_Kepada Pak/Bu {NAMA}_

_*Ringkasan Pesanan*_
- {ITEMS}

_*Ringkasan Tagihan*_
- Subtotal Obat    : Rp {SUBTOTAL}
- Ongkir               : Rp {ONGKIR}
- Diskon Obat      : ~Rp {DISKON_OBAT}~
- Diskon Ongkir   : ~Rp {DISKON_ONGKIR}~

> Anda hemat Rp {HEMAT}
--------------------------------------
*Total Tagihan COD : Rp {TOTAL}*
_Ongkir sudah termasuk biaya COD_`,
  reminder: `Selamat pagi Pak/Bu {NAMA} 🙏😊

Alhamdulillah obatnya sudah sampai ya.
Diminum rutin 3x sehari ya, sekali minum 2 kapsul setelah makan (Disarankan dengan air hangat), semoga lekas diberi kesembuhan 🙏🤲 _Aamiin ya Rabbal ‘alamiin_.

Untuk sementara, mohon *hindari dulu*:

- Makanan berlemak tinggi
- Makanan berkolesterol tinggi (jeroan, kuning telur berlebih, seafood tertentu)
- Makanan cepat saji & gorengan
- Makanan/minuman tinggi garam (asin, makanan olahan/kemasan)
- Rokok & alkohol

Jika nanti ada perubahan membaik tetapi belum maksimal, saya sarankan untuk *di lanjutkan / dipesan kembali obatnya (jika habis)*  agar benar-benar sembuh total 🙏😊

Mohon berkenan kabari saya 4–5 hari ke depan terkait perkembangannya ya takutnya saya kelupaan menanyakan. Simpan nomor saya agar lebih mudah untuk konsultasi dan pemesanan, Terima kasih 🙏😊`
};

const state = {
  rawRows: [],        // semua data (object array dengan _id)
  filteredRows: [],   // hasil filter/search (sebelum pagination)
  pageData: [],       // data pada halaman aktif
  totalRows: 0,
  currentPage: 1,
  rowsPerPage: 5,
  currentSearch: "",
  currentStatus: "",
  dateStart: null,   // tanggal awal filter
  dateEnd: null,  
  hargaSatuan: 355_000,
  waContextIndex: null // index row saat buka WA modal
};

/* ===================== 3) Utilities (REPLACE THIS BLOCK) ===================== */
const Utils = {
  formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    return d.toLocaleString("id-ID", {
      day: "2-digit", month: "short", year: "numeric",
      hour: "2-digit", minute: "2-digit"
    });
  },

  formatPhone(number) {
    if (!number) return "";
    let cleaned = number.toString().replace(/\D/g,"");
    if (cleaned.startsWith("62")) return cleaned;
    if (cleaned.startsWith("0")) return "62" + cleaned.slice(1);
    return "62" + cleaned;
  },

  formatRupiah(num) {
    return new Intl.NumberFormat("id-ID", {
      style: "currency", currency: "IDR", minimumFractionDigits: 0
    }).format(Number(num) || 0);
  },

  formatKurir(code) {
    if (!code) return "";
    const map = { spx:"SPX Express", jnt:"J&T Express", jne:"JNE Express", ninja:"NINJA Express", ide:"ID Express" };
    const key = String(code).toLowerCase().trim();
    return map[key] || code;
  },

    hitungProfit(rows) {
    const idxModal = HEADERS.indexOf("MODAL");
    const idxOmset = HEADERS.indexOf("OMSET");
    const idxProfit = HEADERS.indexOf("PROFIT");

    rows.forEach(r => {
      const modal = parseFloat(r[idxModal]) || 0;
      const omset = parseFloat(r[idxOmset]) || 0;
      const profit = (omset - modal).toString();

      // jika PROFIT kosong atau berbeda, update array + patch ke DB
      if (r[idxProfit] !== profit) {
        r[idxProfit] = profit;
        if (r._id) {
          Data.patchById(r._id, { PROFIT: profit }); 
        }
      }
    });
  },

  /**
   * Safe template filler.
   * - template: string containing placeholders like {NAMA}, {TGLORDER}, {TANGGALUPDATE}, {LASTUPDATE}
   * - rowArr: array ordered like HEADERS (plus may contain extra LASTUPDATE at end)
   */
  fillTemplate(template, rowArr) {
    if (!template) return "";
    let text = String(template);

    // Build keys to replace: HEADERS + any visible extras (keamanan)
    const extraKeys = (typeof VISIBLE_COLUMNS !== "undefined")
      ? VISIBLE_COLUMNS.filter(c => !HEADERS.includes(c))
      : [];
    const keys = HEADERS.concat(extraKeys);

    keys.forEach(col => {
      const key = col.replace(/\./g,"");
      // get value from row array: prefer index from HEADERS
      let val = "";
      const idx = HEADERS.indexOf(col);
      if (idx >= 0) {
        val = rowArr[idx] ?? "";
      } else {
        // fallback: try to find in rowArr by visible columns index (e.g. LASTUPDATE)
        const visIdx = (typeof VISIBLE_COLUMNS !== "undefined") ? VISIBLE_COLUMNS.indexOf(col) : -1;
        val = (visIdx >= 0) ? (rowArr[visIdx] ?? "") : (rowArr[HEADERS.length] ?? "");
      }

      // format known date fields
      if (["TGLORDER", "TANGGALUPDATE"].includes(col)) {
        val = Utils.formatDate(val);
      }

      // replace ALL occurrences, case-insensitive
      try {
        const re = new RegExp("\\{"+key+"\\}", "gi");
        text = text.replace(re, val ?? "");
      } catch (err) {
        // fallback safe replace if regex build fails
        text = text.split("{" + key + "}").join(val ?? "");
      }
    });

    return text;
  },

  hitungSejakUpdate(rows) {
    const idxUpdate = HEADERS.indexOf("TANGGALUPDATE");
    let idxSejak = HEADERS.indexOf("LASTUPDATE");
    if (idxSejak === -1) {
      // don't mutate HEADERS if you prefer immutable; but original code appended
      HEADERS.push("LASTUPDATE");
      idxSejak = HEADERS.length - 1;
    }
    const now = new Date();
    rows.forEach(r => {
      const tgl = new Date(r[idxUpdate]);
      if (!isNaN(tgl)) {
        const diffMs = now - tgl;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const days = Math.floor(diffHours / 24);
        const hours = diffHours % 24;
        let result = "";
        if (days > 0) result += days + " Hari";
        if (hours > 0) result += (result ? " " : "") + hours + " Jam";
        r[idxSejak] = (result || "0 Jam") + " yang lalu";
      } else {
        r[idxSejak] = "";
      }
    });
  },

  parseObat(obatValue, hargaSatuan) {
    if (!obatValue) return { qty: 1, namaProduk: "", itemsText: "", subtotal: 0 };
    const parts = String(obatValue).trim().split(/\s+/);
    const qty = parseInt(parts[0], 10) || 1;
    const namaProduk = parts.slice(2).join(" ");
    const itemsText = `${namaProduk}   x ${qty}`;
    const subtotal = qty * (Number(hargaSatuan) || 0);
    return { qty, namaProduk, itemsText, subtotal };
  },

  refreshInvoiceFields(textarea, fields, obatnya, hargaSatuan) {
    const { subtotal } = Utils.parseObat(obatnya, hargaSatuan);
    const ongkir = parseInt(fields.ongkir.value, 10) || 0;
    const diskonObat = parseInt(fields.diskonObat.value, 10) || 0;
    const diskonOngkir = parseInt(fields.diskonOngkir.value, 10) || 0;
    const hemat = diskonObat + diskonOngkir;
    const total = subtotal + ongkir - hemat;

    let text = textarea.value;
    text = text.replace(/- Subtotal Obat\s*:\s*Rp[^\n]*/i, `- Subtotal Obat   : ${Utils.formatRupiah(subtotal)}`);
    text = text.replace(/- Ongkir\s*:\s*Rp[^\n]*/i, `- Ongkir               : ${Utils.formatRupiah(ongkir)}`);
    text = text.replace(/- Diskon Obat\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Obat     : ~${Utils.formatRupiah(diskonObat)}~`);
    text = text.replace(/- Diskon Ongkir\s*:\s*~?\s*Rp[^\n]*~?/i, `- Diskon Ongkir  : ~${Utils.formatRupiah(diskonOngkir)}~`);
    text = text.replace(/^> *Anda hemat.*$/mi, `> Anda hemat ${Utils.formatRupiah(hemat)}`);
    text = text.replace(/^\**\s*Total Tagihan COD\s*:?\s*Rp[^\n]*\**$/mi, `*Total Tagihan COD ${Utils.formatRupiah(total)}*`);
    textarea.value = text;
  }
};
/* ===================== end Utilities ===================== */

/* ===================== 4) Data Access (RDB) ===================== */
const Data = {
  async loadAll() {
    const snapshot = await get(ref(db, "data-pelanggan"));
    if (!snapshot.exists()) return [];
    const raw = snapshot.val();
    const rows = Object.entries(raw).map(([id, obj]) => {
      const arr = HEADERS.map(h => obj[h] ?? "");
      arr._id = id;
      return arr;
    });
    return rows;
  },
  async updateById(id, rowArray) {
    const payload = {};
    HEADERS.forEach((col, i) => payload[col] = rowArray[i] ?? "");
    await update(ref(db, `data-pelanggan/${id}`), payload);
  },
  async patchById(id, patchObj) {
    await update(ref(db, `data-pelanggan/${id}`), patchObj);
  }
};

/* ===================== 5) Render ===================== */
const Render = {
  renderFilterOptions() {
    const sel = document.getElementById("filterStatus");
    if (!sel) return;
    const statusIdx = HEADERS.indexOf("STATUS");
    const distinct = [...new Set(state.rawRows.map(r => r[statusIdx]).filter(Boolean))].sort();
    // clear except first (Semua)
    sel.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());
    distinct.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      sel.appendChild(opt);
    });
  },
  table() {
    const thead = document.querySelector("#dataTable thead tr");
    const tbody = document.querySelector("#dataTable tbody");
    if (!thead || !tbody) return;

    const cols = VISIBLE_COLUMNS.filter(c => HEADERS.includes(c));
    thead.innerHTML = "<th style='width:56px'>#</th>" + cols.map(c => `<th>${c}</th>`).join("") + "<th style='width:140px'>AKSI</th>";

    tbody.innerHTML = "";
    const startIdx = (state.currentPage - 1) * state.rowsPerPage;

    state.pageData.forEach((row, i) => {
      const tr = document.createElement("tr");
      let cells = `<td>${startIdx + i + 1}</td>`;
      cols.forEach(col => {
        const idx = HEADERS.indexOf(col);
        let val = row[idx] ?? "";
        if (col === "TGLORDER" || col === "TANGGALUPDATE") val = Utils.formatDate(val);
        if (col === "KURIR") val = Utils.formatKurir(val);
        if (col === "PROFIT")val = Utils.formatRupiah(val);
        cells += `<td>${val}</td>`;
      });

      const localIndex = i; // index dalam pageData
      cells += `<td class="text-nowrap">
        <button class="btn btn-sm btn-warning me-1" title="Edit" onclick="App.showEditFull(${localIndex})">
          <i class="bi bi-pencil-fill"></i>
        </button>
        <button class="btn btn-sm btn-success me-1" title="Kirim WA" onclick="App.showWaModal(${localIndex})">
          <i class="bi bi-whatsapp"></i>
        </button>
        <button class="btn btn-sm btn-primary me-1" title="Cek Resi" onclick="App.confirmTrackResi(${localIndex})">
          <i class="bi bi-truck"></i>
        </button>
        <button class="btn btn-sm btn-danger" title="Hapus" onclick="App.deleteRow(${localIndex})">
            <i class="bi bi-trash"></i>
        </button>
      </td>`;

      tr.innerHTML = cells;
      tbody.appendChild(tr);
    });

    // Pagination
    Render.pagination();
    // Total label
    document.getElementById("totalRowsLabel").textContent = String(state.filteredRows.length);
    Render.totalProfit();
  },
  
  pagination() {
    const container = document.getElementById("pagination");
    if (!container) return;
    container.innerHTML = "";

    const totalPages = Math.max(1, Math.ceil(state.filteredRows.length / state.rowsPerPage));

    const btn = (label, page, disabled=false, active=false) => {
      const b = document.createElement("button");
      b.className = `btn btn-sm ${active ? "btn-primary" : "btn-outline-primary"}`;
      b.textContent = label;
      b.disabled = disabled;
      b.onclick = () => Actions.changePage(page);
      return b;
    };

    container.appendChild(btn("First", 1, state.currentPage===1));
    container.appendChild(btn("Prev", Math.max(1, state.currentPage-1), state.currentPage===1));

    const maxVisible = 5;
    let start = Math.max(1, state.currentPage - Math.floor(maxVisible/2));
    let end = Math.min(totalPages, start + maxVisible - 1);
    if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);

    if (start > 1) {
      container.appendChild(btn("1", 1, false, state.currentPage===1));
      if (start > 2) {
        const span = document.createElement("span"); span.className = "px-1"; span.textContent = "…";
        container.appendChild(span);
      }
    }

    for (let p = start; p <= end; p++) {
      container.appendChild(btn(String(p), p, false, state.currentPage===p));
    }

    if (end < totalPages) {
      if (end < totalPages - 1) {
        const span = document.createElement("span"); span.className = "px-1"; span.textContent = "…";
        container.appendChild(span);
      }
      container.appendChild(btn(String(totalPages), totalPages, false, state.currentPage===totalPages));
    }

    container.appendChild(btn("Next", Math.min(totalPages, state.currentPage+1), state.currentPage===totalPages));
    container.appendChild(btn("Last", totalPages, state.currentPage===totalPages));
  },
  totalProfit() {
  const idxProfit = HEADERS.indexOf("PROFIT");
  let total = 0;

  state.pageData.forEach(r => {
    const val = parseFloat(r[idxProfit]) || 0;
    total += val;
  });

  // Format rupiah
  const formatted = new Intl.NumberFormat("id-ID", { 
    style: "currency", 
    currency: "IDR" 
  }).format(total);

  document.getElementById("totalProfit").innerText = formatted;
}
};

/* ===================== 6) Actions (logic) ===================== */
const Actions = {
  async loadData() {
    // load semua data
    state.rawRows = await Data.loadAll();
    // hitung PROFIT otomatis (sekalian patch kalau kosong/beda)
  Utils.hitungProfit(state.rawRows);

    // hitung LASTUPDATE (derived)
    Utils.hitungSejakUpdate(state.rawRows);

    // filter & search
    Actions.applySearchFilter();

    // render
    Render.renderFilterOptions();
    Render.table();
  },

  applySearchFilter() {
    let rows = [...state.rawRows];

  // Filter status
  if (state.currentStatus) {
    const idxStatus = HEADERS.indexOf("STATUS");
    rows = rows.filter(r => String(r[idxStatus] || "") === state.currentStatus);
  }

  // Filter tanggal (TGLORDER)
  if (state.dateStart || state.dateEnd) {
    const idxTgl = HEADERS.indexOf("TGLORDER");
    rows = rows.filter(r => {
      const d = new Date(r[idxTgl]);
      if (isNaN(d)) return false;
      if (state.dateStart && d < new Date(state.dateStart)) return false;
      if (state.dateEnd && d > new Date(state.dateEnd)) return false;
      return true;
    });
  }

  // Search (di semua kolom)
  if (state.currentSearch) {
    const kw = state.currentSearch.toLowerCase();
    rows = rows.filter(r => r.some(v => String(v || "").toLowerCase().includes(kw)));
  }


    // Sort default TGLORDER desc (jika ada data tanggal valid)
    const idxTgl = HEADERS.indexOf("TGLORDER");
    rows.sort((a,b) => {
      const da = new Date(a[idxTgl]), db = new Date(b[idxTgl]);
      if (isNaN(da) && isNaN(db)) return 0;
      if (isNaN(da)) return 1;
      if (isNaN(db)) return -1;
      return db - da;
    });

    state.filteredRows = rows;
    state.totalRows = rows.length;

    // Pagination slice
    const start = (state.currentPage - 1) * state.rowsPerPage;
    state.pageData = rows.slice(start, start + state.rowsPerPage);
  },

  changePage(page) {
    const totalPages = Math.max(1, Math.ceil(state.filteredRows.length / state.rowsPerPage));
    state.currentPage = Math.min(Math.max(1, page), totalPages);
    Actions.applySearchFilter();
    Render.table();
  },

  resetFilter() {
    document.getElementById("searchBox").value = "";
    document.getElementById("filterStatus").value = "";
    state.currentSearch = "";
    state.currentStatus = "";
    state.currentPage = 1;
    Actions.applySearchFilter();
    Render.table();
  },

  /* ====== Edit ====== */
  showEditFull(localIndex) {
    const modalBody = document.querySelector("#editForm .modal-body");
    if (!modalBody) return;
    modalBody.innerHTML = "";

    const row = state.pageData[localIndex];
    if (!row) return;

    // build inputs dari HEADERS
    HEADERS.forEach((col, i) => {
      const val = row[i] ?? "";
      const formGroup = document.createElement("div");
      formGroup.className = "mb-3";
      formGroup.innerHTML = `
        <label class="form-label">${col}</label>
        <input type="text" class="form-control" name="col_${i}" value="${String(val).replace(/"/g,'&quot;')}">
      `;
      modalBody.appendChild(formGroup);
    });

    // hidden index
    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.name = "localIndex";
    hidden.value = String(localIndex);
    modalBody.appendChild(hidden);

    new bootstrap.Modal(document.getElementById("editModal")).show();
  },

  async submitEditForm(e) {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const localIndex = parseInt(fd.get("localIndex"), 10);

    // reconstruct row array
    const newRow = HEADERS.map((_, i) => fd.get(`col_${i}`) ?? "");

    // hitung PROFIT dari OMSET - MODAL
const idxModal = HEADERS.indexOf("MODAL");
const idxOmset = HEADERS.indexOf("OMSET");
const idxProfit = HEADERS.indexOf("PROFIT");

const modal = parseFloat(newRow[idxModal]) || 0;
const omset = parseFloat(newRow[idxOmset]) || 0;
newRow[idxProfit] = (omset - modal).toString();

    const row = state.pageData[localIndex];
    if (!row) return;

    const globalIndex = (state.currentPage - 1) * state.rowsPerPage + localIndex;
    const id = state.filteredRows[globalIndex]._id;

    await Data.updateById(id, newRow);

    // update di cache
    state.filteredRows[globalIndex] = Object.assign([...newRow], { _id: id });
    Actions.applySearchFilter();
    Render.table();

    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
  },

  /* ====== WhatsApp ====== */
  showWaModal(localIndex) {
    state.waContextIndex = localIndex;
    const row = state.pageData[localIndex];
    if (!row) return;

    const nama = row[HEADERS.indexOf("NAMA")] || "";
    const noresi = row[HEADERS.indexOf("NORESI")] || "";
    const tglorder = Utils.formatDate(row[HEADERS.indexOf("TGLORDER")] || "");
    const tglupdate = Utils.formatDate(row[HEADERS.indexOf("TANGGALUPDATE")] || "");
    const kurir = Utils.formatKurir(row[HEADERS.indexOf("KURIR")] || "");
    const obatnya = row[HEADERS.indexOf("BARANG")] || "";
    const tracking = row[HEADERS.indexOf("PELACAKANTERBARU")] || "";
    const status = row[HEADERS.indexOf("STATUS")] || "";

    const textarea = document.getElementById("waMessage");
    const select = document.getElementById("waTemplate");
    const invBox = document.getElementById("invoiceFields");
    const ongkirEl = document.getElementById("invOngkir");
    const diskonObatEl = document.getElementById("invDiskonObat");
    const diskonOngkirEl = document.getElementById("invDiskonOngkir");

    // default infopesanan
    textarea.value = Utils.fillTemplate(WATemplates.infopesanan, row)
      .replace("{NAMA}", nama)
      .replace("{NORESI}", noresi)
      .replace("{OBATNYA}", obatnya)
      .replace("{TGLUPDATE}", tglupdate)
      .replace("{TGLORDER}", tglorder)
      .replace("{KURIRE}", kurir)
      .replace("{TRACKING}", tracking)
      .replace("{STATUS}", status);

    select.value = "";
    invBox.style.display = "none";
    ongkirEl.value = "0"; diskonObatEl.value = "0"; diskonOngkirEl.value = "0";

    // on change template
    select.onchange = () => {
      if (select.value === "invoice") {
        invBox.style.display = "block";
        const { itemsText, subtotal } = Utils.parseObat(obatnya, state.hargaSatuan);
        const ongkir = parseInt(ongkirEl.value,10)||0;
        const dObat = parseInt(diskonObatEl.value,10)||0;
        const dOngkir = parseInt(diskonOngkirEl.value,10)||0;
        const hemat = dObat + dOngkir;
        const total = subtotal + ongkir - hemat;

        textarea.value = Utils.fillTemplate(WATemplates.invoice, row)
          .replace("{TGLORDER}", tglorder)
          .replace("{NAMA}", nama)
          .replace("{ITEMS}", itemsText)
          .replace("{NORESI}", noresi)
          .replace("{OBATNYA}", obatnya)
          .replace("{SUBTOTAL}", Utils.formatRupiah(subtotal))
          .replace("{ONGKIR}", Utils.formatRupiah(ongkir))
          .replace("{DISKON_OBAT}", Utils.formatRupiah(dObat))
          .replace("{KURIRE}", kurir)
          .replace("{DISKON_ONGKIR}", Utils.formatRupiah(dOngkir))
          .replace("{HEMAT}", Utils.formatRupiah(hemat))
          .replace("{TOTAL}", Utils.formatRupiah(total));

        [ongkirEl, diskonObatEl, diskonOngkirEl].forEach(el => {
          el.oninput = () => Utils.refreshInvoiceFields(
            textarea,
            { ongkir: ongkirEl, diskonObat: diskonObatEl, diskonOngkir: diskonOngkirEl },
            obatnya, state.hargaSatuan
          );
        });

      } else {
        invBox.style.display = "none";
        const tpl = WATemplates[select.value] || WATemplates.infopesanan;
        textarea.value = Utils.fillTemplate(tpl, row)
          .replace("{NAMA}", nama)
          .replace("{NORESI}", noresi)
          .replace("{OBATNYA}", obatnya)
          .replace("{TGLUPDATE}", tglupdate)
          .replace("{TGLORDER}", tglorder)
          .replace("{KURIRE}", kurir)
          .replace("{TRACKING}", tracking)
          .replace("{STATUS}", status);
      }
    };

    const sendBtn = document.getElementById("waSendBtn");
    sendBtn.onclick = () => {
      const nomor = Utils.formatPhone(row[HEADERS.indexOf("WHATSAPP")]||"");
      const pesan = encodeURIComponent(textarea.value);
      window.open(`https://wa.me/${nomor}?text=${pesan}`, "_blank");
    };

    new bootstrap.Modal(document.getElementById("waModal")).show();
  },

  /* ====== Tracking / Cek Resi (BinderByte) ====== */
  confirmTrackResi(localIndex) {
    if (confirm("Yakin mau cek resi untuk data ini?")) {
      Actions.trackResi(localIndex);
    }
  },

  async trackResi(localIndex) {
    const row = state.pageData[localIndex];
    if (!row) return alert("Baris tidak ditemukan.");
    const idx = (name) => HEADERS.indexOf(name);

    const resi = row[idx("NORESI")];
    const kurir = row[idx("KURIR")];
    if (!resi || !kurir) return alert("Nomor resi atau kurir kosong!");

    try {
      const url = `https://api.binderbyte.com/v1/track?api_key=7dfb0627d2a03a05e81b82f4565f6b1e1517f280708a6cc9644b58ff6330a793&courier=${encodeURIComponent(kurir)}&awb=${encodeURIComponent(resi)}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Gagal fetch BinderByte");

      const result = await response.json();
      const history = result.data?.history || [];
      if (history.length === 0) return alert("Tidak ada history tracking!");

      const last = history[0];
      const lastDesc = last.desc || "";
      const lastDate = last.date || "";
      const status   = result.data?.summary?.status || "";

      // Durasi kirim
      let duration = "";
      if (history.length > 1) {
        const start = new Date(history[history.length - 1].date);
        const end   = new Date(history[0].date);
        const diff  = end - start;
        if (!isNaN(diff)) {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          if (hours < 24) duration = hours + " Jam";
          else {
            const days = Math.floor(hours / 24);
            const hRem = hours % 24;
            duration = `${days} Hari ${hRem} Jam`;
          }
        }
      }

      // cari id dokumen (global index)
      const globalIndex = (state.currentPage - 1) * state.rowsPerPage + localIndex;
      const id = state.filteredRows[globalIndex]._id;

      // patch ke DB
      await Data.patchById(id, {
        PELACAKANTERBARU: lastDesc,
        TANGGALUPDATE: lastDate,
        STATUS: status,
        DURASIKIRIM: duration
      });

      // update di cache
      row[idx("PELACAKANTERBARU")] = lastDesc;
      row[idx("TANGGALUPDATE")] = lastDate;
      row[idx("STATUS")] = status;
      row[idx("DURASIKIRIM")] = duration;

      // recalc LASTUPDATE hanya baris ini
      Utils.hitungSejakUpdate([row]);
      Render.table();

    } catch (err) {
      console.error(err);
      alert("Terjadi error saat tracking resi: " + err.message);
    }
  },

async deleteRow(localIndex) {
  const row = state.pageData[localIndex];
  if (!row) return;

  const id = row._id; // key unik di RDB
  if (confirm("Yakin ingin menghapus data ini?")) {
    try {
      await remove(ref(db, "data-pelanggan/" + id));
      alert("Data berhasil dihapus.");
      await Actions.loadData(); // refresh tabel setelah hapus
    } catch (e) {
      console.error("Gagal hapus:", e);
      alert("Gagal menghapus data!");
    }
  }
}
};

/* ===================== 7) Wiring UI ===================== */
document.getElementById("btnRefresh").addEventListener("click", () => Actions.loadData());
document.getElementById("btnReset").addEventListener("click", () => Actions.resetFilter());
document.getElementById("rowsPerPage").addEventListener("change", (e) => {
  state.rowsPerPage = parseInt(e.target.value, 10) || 5;
  state.currentPage = 1;
  Actions.applySearchFilter();
  Render.table();
});
document.getElementById("searchBox").addEventListener("input", (e) => {
  state.currentSearch = e.target.value.trim();
  state.currentPage = 1;
  Actions.applySearchFilter();
  Render.table();
});
document.getElementById("filterStatus").addEventListener("change", (e) => {
  state.currentStatus = e.target.value;
  state.currentPage = 1;
  Actions.applySearchFilter();
  Render.table();
});
// Filter berdasarkan range tanggal
document.getElementById("dateStart").addEventListener("change", (e) => {
  state.dateStart = e.target.value;
  state.currentPage = 1;
  Actions.applySearchFilter();
  Render.table();
});
document.getElementById("dateEnd").addEventListener("change", (e) => {
  state.dateEnd = e.target.value;
  state.currentPage = 1;
  Actions.applySearchFilter();
  Render.table();
});
document.getElementById("editForm").addEventListener("submit", Actions.submitEditForm);

/* ===================== 8) Init ===================== */
Actions.loadData();

/* ===================== 9) Expose ke Window (untuk onClick inline) ===================== */
window.App = {
  ...Actions
};
</script>
</body>
</html>
